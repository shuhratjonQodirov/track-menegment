<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Boshqaruv Tizimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>

        @keyframes highlightRow {
            0% {
                background-color: #dbeafe;
                transform: scale(1.02);
            }
            /* Blue-100 va biroz kattalashish */
            100% {
                background-color: transparent;
                transform: scale(1);
            }
        }


        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-gray-100">
<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-96">
        <h2 class="text-2xl font-bold mb-6 text-blue-600">Tizimga kirish</h2>
        <form id="loginForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Username (PNFL)</label>
                <input type="text" id="username"
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2">Password</label>
                <input type="password" id="password"
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                Kirish
            </button>
        </form>
        <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
    <!-- Header -->
    <div class="bg-white shadow-md">
        <div class="container mx-auto">
            <div class="flex items-center justify-between p-4 bg-white shadow-sm">
                <h1 class="text-2xl font-bold text-blue-600">Transport Boshqaruvi</h1>
                <div class="flex items-center gap-4 relative">

                    <button onclick="toggleProfileMenu()"
                            class="flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition focus:outline-none border-2 border-blue-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </button>

                    <div id="profileDropdown"
                         class="hidden absolute top-12 right-20 w-72 bg-white rounded-2xl shadow-2xl border border-gray-100 z-[100] p-5">
                        <div class="flex flex-col items-center border-b pb-4 mb-4">
                            <div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold mb-2">
                                <span id="userInitial">U</span>
                            </div>
                            <h3 id="profileName" class="text-lg font-bold text-gray-800 text-center leading-tight">
                                ...</h3>
                            <span id="profileRole"
                                  class="text-xs font-black text-blue-500 uppercase tracking-widest mt-1">...</span>
                        </div>

                        <div class="space-y-3 mb-4">
                            <div class="flex items-center gap-3">
                                <span class="p-2 bg-gray-50 rounded-lg text-gray-400">üìû</span>
                                <p id="profilePhone" class="text-sm font-semibold text-gray-600">...</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="p-2 bg-gray-50 rounded-lg text-gray-400">üìç</span>
                                <p id="profileAddress" class="text-sm font-semibold text-gray-600">...</p>
                            </div>
                        </div>

                        <button onclick="logout()"
                                class="w-full py-2.5 bg-red-50 text-red-600 rounded-xl hover:bg-red-600 hover:text-white font-bold transition">
                            Chiqish
                        </button>
                    </div>

                </div>
            </div>

            <!-- Navigation -->
            <div class="flex border-t">
                <button onclick="showTab('dashboard')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100"
                        data-tab="dashboard">
                    üìä Dashboard
                </button>
                <button onclick="showTab('users')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100"
                        data-tab="users">
                    üë• Foydalanuvchilar
                </button>
                <button onclick="showTab('trucks')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100"
                        data-tab="trucks">
                    üöõ Mashinalar
                </button>
                <button onclick="showTab('trips')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100"
                        data-tab="trips">
                    üó∫Ô∏è Reyslar
                </button>
                <button onclick="showTab('settings')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100"
                        data-tab="settings">
                    ‚öôÔ∏è Sozlamalar
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content container mx-auto p-6 bg-gray-50 min-h-screen">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Boshqaruv Paneli</h2>

        <div id="dashboardStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium opacity-80 uppercase tracking-wider">Jami Reyslar</p>
                        <p id="totalTrips" class="text-4xl font-bold mt-2">0</p>
                    </div>
                    <i class="fas fa-route text-2xl opacity-50"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="text-blue-600">üìä</span> Moliyaviy ko'rsatkichlar
                </h3>

                <div class="relative h-64 mb-8">
                    <canvas id="financeChart"></canvas>
                </div>

                <div class="grid grid-cols-3 gap-6 pt-6 border-t border-gray-50">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Yoqilg'i</p>
                        <p id="fuelExp" class="text-lg font-bold text-orange-600">$0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Texnik xizmat</p>
                        <p id="serviceExp" class="text-lg font-bold text-purple-600">$0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Oyliklar</p>
                        <p id="salaryExp" class="text-lg font-bold text-blue-600">$0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="text-purple-600">üèÜ</span> Top Haydovchilar
                </h3>
                <div id="topDriversList" class="space-y-6">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800">üìç Oxirgi reyslar</h3>
                <div id="recentTripsList" class="divide-y divide-gray-50">
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800">üöõ Mashinalar holati</h3>
                <div id="truckStatusList" class="space-y-4">
                </div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content container mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <!-- <<< YANGI ID >>> Header -->
            <div id="usersHeader" class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Foydalanuvchilar</h2>
                <div class="relative flex-1 max-w-md mx-4">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </span>
                    <input type="text"
                           id="userSearchInput"
                           onkeyup="searchUsers()"
                           placeholder="Foydalanuvchi ismi bilan qidiruv..."
                           class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>
                <button onclick="openAddUserModal()"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    + Foydalanuvchi qo'shish
                </button>
            </div>

            <!-- <<< YANGI ID >>> User Type Tabs -->
            <div id="userTypeTabs" class="flex gap-2 mb-6">
                <button onclick="filterUsers('DRIVER')"
                        class="user-filter-btn px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold"
                        data-role="DRIVER">
                    Haydovchilar
                </button>
                <button onclick="filterUsers('MANAGER')"
                        class="user-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold"
                        data-role="MANAGER">
                    Menejerlar
                </button>
                <button onclick="filterUsers('ECONOMIST')"
                        class="user-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold"
                        data-role="ECONOMIST">
                    Iqtisodchilar
                </button>
            </div>

            <div id="usersList" class="space-y-3">
                <!-- Users will be loaded here -->
            </div>

        </div>
    </div>

    <!-- Trucks Tab -->
    <div id="trucks-tab" class="tab-content container mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <h2 class="text-2xl font-bold">Mashinalar</h2>

                <div class="relative flex-1 max-w-md mx-4">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </span>
                    <input type="text"
                           id="truckSearchInput"
                           onkeyup="searchTrucks()"
                           placeholder="Mashina raqami bo'yicha qidiruv..."
                           class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>

                <button onclick="openAddTruckModal()"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition shadow-md">
                    + Mashina qo'shish
                </button>
            </div>

            <div id="trucksList" class="space-y-3">
                <!-- Trucks will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Trips Tab -->
    <div id="trips-tab" class="tab-content container mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Reyslar</h2>

                <div class="relative flex-1 max-w-md mx-4">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </span>
                    <input type="text"
                           id="tripSearchInput"
                           onkeyup="searchTrucks()"
                           placeholder="Sayoxat id bilan qidiruv..."
                           class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>
                <button onclick="openAddTripModal()"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    + Reys qo'shish
                </button>
            </div>

            <div id="tripsList" class="space-y-3">
                <!-- Trips will be loaded here -->
            </div>
            <!-- üîΩ TANLANGAN REYS TAFSILOTLARI -->
            <div id="tripDetailsSection" class="hidden mt-8">
                <!-- Details shu yerda ochiladi -->
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content container mx-auto p-4 hidden">
        <style>
            .settings-layout { display: grid; grid-template-columns: 280px 1fr; gap: 25px; }
            .settings-sidebar { background: #f8fafc; border-radius: 12px; padding: 15px; height: fit-content; border: 1px solid #e2e8f0; }
            .sidebar-item { padding: 12px 16px; margin-bottom: 6px; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; color: #475569; font-weight: 500; }
            .sidebar-item:hover { background: #f1f5f9; }
            .sidebar-item.active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
            .settings-content { background: white; border-radius: 12px; padding: 30px; border: 1px solid #e2e8f0; min-height: 600px; }
            .settings-section { display: none; }
            .settings-section.active { display: block; animation: fadeIn 0.3s ease; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
            .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #475569; font-size: 13px; }
            .form-input { width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.2s; }
            .btn-save { background: #2563eb; color: white; padding: 10px 24px; border-radius: 8px; font-weight: 600; transition: 0.2s; border: none; cursor: pointer; }
            @media (max-width: 992px) { .settings-layout { grid-template-columns: 1fr; } .settings-sidebar { display: flex; overflow-x: auto; gap: 10px; } }
        </style>

        <div class="settings-layout">
            <aside class="settings-sidebar">
                <div class="sidebar-item active" data-section="profile">üë§ Profil</div>
                <div class="sidebar-item" data-section="account">üîê Xavfsizlik</div>
                <div class="sidebar-item" data-section="transport">üöõ Transport</div>
                <div class="sidebar-item" data-section="backup">üíæ Ma'lumotlar</div>
            </aside>

            <main class="settings-content">
                <section class="settings-section active" id="profile">
                    <h2 class="text-2xl font-bold mb-6">Foydalanuvchi ma'lumotlari</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Ism</label>
                            <input type="text" class="form-input" id="set_name" value="Qodirov">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Familiya</label>
                            <input type="text" class="form-input" id="set_surname" value="Shuhratjon">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="form-label">Telefon</label>
                        <input type="tel" class="form-input" id="set_phone" value="+998905823433">
                    </div>
                    <button class="btn-save mt-6" onclick="saveProfileSettings()">O'zgarishlarni saqlash</button>
                </section>

                <section class="settings-section" id="account">
                    <h2 class="text-2xl font-bold mb-6">Xavfsizlik</h2>
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="form-label">Yangi parol</label>
                            <input type="password" class="form-input" id="new_pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <button class="btn-save mt-6">Parolni yangilash</button>
                </section>

                <section class="settings-section" id="transport">
                    <h2 class="text-2xl font-bold mb-6">Tariflar</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Yoqilg'i narxi (1L)</label>
                            <input type="number" class="form-input" value="11000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Xizmat haqi (1km)</label>
                            <input type="number" class="form-input" value="2500">
                        </div>
                    </div>
                    <button class="btn-save mt-6">Saqlash</button>
                </section>

                <section class="settings-section" id="backup">
                    <h2 class="text-2xl font-bold mb-6 text-red-600">Ma'lumotlar</h2>
                    <div class="p-6 bg-red-50 rounded-xl border border-red-100">
                        <p class="text-red-800 mb-4">Barcha reyslar va moliyaviy ma'lumotlarni eksport qiling.</p>
                        <button class="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg font-bold">üì• Excel Eksport</button>
                    </div>
                </section>
            </main>
        </div>
    </div>
    <!-- User Details Section -->
    <div id="userDetailsSection" class="hidden">
        <!-- Batafsil ma'lumotlar shu yerda -->
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6">Yangi foydalanuvchi qo'shish</h3>
        <form id="addUserForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Lavozim *</label>
                <select name="userType" class="w-full px-4 py-2 border rounded-lg" required>
                    <option value="">Tanlang</option>
                    <option value="DRIVER">Haydovchi</option>
                    <option value="MANAGER">Meneger</option>
                    <option value="ECONOMIST">Iqtisodchi</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">F.I.O *</label>
                    <input type="text" name="fullName" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Telefon *</label>
                    <input type="text" name="phoneNumber" class="w-full px-4 py-2 border rounded-lg"
                           placeholder="+998901234567" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Passport *</label>
                    <input type="text" name="passportNumber" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">PNFL *</label>
                    <input type="text" name="pnfl" class="w-full px-4 py-2 border rounded-lg" maxlength="14" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Parol *</label>
                    <input type="password" name="password" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Manzil *</label>
                    <input type="text" name="address" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Tug'ilgan sana *</label>
                    <input type="date" name="brithDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Ishga kirgan sana *</label>
                    <input type="date" name="hireDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    ‚úì Saqlash
                </button>
                <button type="button" onclick="closeAddUserModal()"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                    Bekor qilish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Truck Modal -->
<div id="addTruckModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6">Yangi mashina qo'shish</h3>
        <form id="addTruckForm">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Davlat raqami *</label>
                    <input type="text" name="truckNumber" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Model *</label>
                    <input type="text" name="modelName" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Yili *</label>
                    <input type="number" name="manufactureYear" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Narxi ($) *</label>
                    <input type="number" step="0.01" name="buyPrice" class="w-full px-4 py-2 border rounded-lg"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Sotib olingan sana *</label>
                    <input type="date" name="buyDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Holati *</label>
                    <select name="truckStatus" class="w-full px-4 py-2 border rounded-lg" required>
                        <option value="ACTIVE">ACTIVE</option>
                        <option value="REPAIR">REPAIR</option>
                        <option value="INACTIVE">INACTIVE</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    ‚úì Saqlash
                </button>
                <button type="button" onclick="closeAddTruckModal()"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                    Bekor qilish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Trip Modal -->
<div id="addTripModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6">Yangi reys qo'shish</h3>
        <form id="addTripForm">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Mashina *</label>
                    <select name="truckId" id="tripTruckSelect" class="w-full px-4 py-2 border rounded-lg" required>
                        <option value="">Tanlang</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Haydovchi *</label>
                    <select name="userId" id="tripDriverSelect" class="w-full px-4 py-2 border rounded-lg" required>
                        <option value="">Tanlang</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Qayerdan *</label>
                    <input type="text" name="routeFrom" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Qayerga *</label>
                    <input type="text" name="routeTo" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Chiqish narxi ($) *</label>
                    <input type="number" step="0.01" name="incomeOutUsd" class="w-full px-4 py-2 border rounded-lg"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Qaytish narxi ($) *</label>
                    <input type="number" step="0.01" name="incomeBackUsd" class="w-full px-4 py-2 border rounded-lg"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Haydovchi oyligi ($) *</label>
                    <input type="number" step="0.01" name="driverIncomeUsd" class="w-full px-4 py-2 border rounded-lg"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Boshlangan sana *</label>
                    <input type="date" name="startedDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Davomiyligi (kun)</label>
                    <input type="number" name="tripDuration" class="w-full px-4 py-2 border rounded-lg" value="0">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    ‚úì Saqlash
                </button>
                <button type="button" onclick="closeAddTripModal()"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                    Bekor qilish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Trip Details Modal -->
<div id="tripDetailsModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold">Reys ma'lumotlari</h3>
            <button onclick="closeTripDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;
            </button>
        </div>
        <div id="tripDetailsContent">
            <!-- Details will be loaded here -->
        </div>
    </div>
</div>

<!-- Fuel Modal -->
<div id="fuelModal"
     class="fixed inset-0 z-[150] hidden overflow-y-auto backdrop-blur-sm bg-black/40 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white w-full max-w-lg shadow-[0_20px_40px_rgba(0,0,0,0.12)] rounded-[24px] border border-gray-100 p-6 transform transition-all">

            <div class="flex justify-between items-center mb-5">
                <div>
                    <h3 class="text-xl font-bold text-gray-900 tracking-tight">Yonilg‚Äòi sarfi</h3>
                    <p class="text-[12px] text-gray-400">Xarajatni kiriting</p>
                </div>
                <button onclick="closeFuelModal()"
                        class="p-1.5 bg-gray-50 hover:bg-gray-100 rounded-full transition-colors group">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-red-500" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="fuelForm" class="space-y-4">
                <input type="hidden" id="fuelTripId">
                <input type="hidden" id="fuelTruckId">

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Litr</label>
                        <input type="number" step="0.01" id="fuelLitres"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                               placeholder="0.00" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Narxi (1L uchun)</label>
                        <input type="number" step="0.01" id="fuelPricePerLitres"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                               placeholder="0.00" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Valyuta</label>
                        <select id="fuelLocalCurrency"
                                class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer font-semibold text-gray-700">
                            <option value="UZS">UZS</option>
                            <option value="USD">USD</option>
                            <option value="RUB">RUB</option>
                            <option value="KZT">KZT</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Mahalliy summa</label>
                        <input type="number" step="0.01" id="fuelAmountLocal"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                               placeholder="0.00" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-bold text-blue-600 ml-1">Jami USD</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400 font-bold text-xs">$</span>
                            <input type="number" step="0.01" id="fuelTotalAmountUsd"
                                   class="w-full bg-blue-50/50 border-none ring-1 ring-blue-100 rounded-xl p-3 pl-7 text-sm focus:ring-2 focus:ring-blue-600 outline-none font-bold text-blue-700"
                                   placeholder="0.00" required>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Sana</label>
                        <input type="date" id="fuelDate"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer"
                               required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Shoxobcha</label>
                        <input type="text" id="fuelGasStationName"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                               placeholder="Nomini kiriting" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Davlat</label>
                        <input type="text" id="fuelCountry"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                               placeholder="Masalan: O'zbekiston" required>
                    </div>
                </div>

                <div class="flex gap-3 pt-3">
                    <button type="button" onclick="closeFuelModal()"
                            class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-200 transition-all active:scale-95">
                        Bekor qilish
                    </button>
                    <button type="submit"
                            class="flex-1 py-3 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-100 transition-all active:scale-95">
                        Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Trip Expense Modal -->
<div id="expenseModal"
     class="fixed inset-0 z-[150] hidden overflow-y-auto backdrop-blur-sm bg-black/40 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white w-full max-w-md shadow-2xl rounded-[32px] border border-gray-100 p-8">

            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900 tracking-tight">Xarajat qo'shish</h3>
                <button onclick="closeModal()"
                        class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="expenseForm" class="space-y-6">
                <input type="hidden" id="tripIdField">

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Xarajat turi</label>
                    <select id="type"
                            class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer"
                            required>
                        <option value="ROAD_TAX">üõ£Ô∏è Yo ªl solig ªi</option>
                        <option value="PARKING">üÖøÔ∏è To ªxtash joyi</option>
                        <option value="BROKER_FEE">ü§ù Posrednik to ªlovi</option>
                        <option value="CUSTOMS_DUTY">üõÉ Bojxona to ªlovi</option>
                        <option value="FINE">‚ö†Ô∏è Jarima</option>
                        <option value="WEIGHING">‚öñÔ∏è Vesovoy</option>
                        <option value="ESCORT">üöî Soprovog ªdeniye</option>
                        <option value="LOADING_UNLOADING">üì¶ Yuk ortish/tushirish</option>
                        <option value="TOLL_ROAD">üé´ Pullik yo ªl</option>
                        <option value="OTHER">üìÅ Boshqa</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Mahalliy summa</label>
                        <input type="number" id="amountLocal" step="0.01" placeholder="0.00"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                               required>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Valyuta</label>
                        <select id="localCurrency"
                                class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer font-bold text-gray-700">
                            <option value="UZS">UZS</option>
                            <option value="USD">USD</option>
                            <option value="RUB">RUB</option>
                            <option value="KZT">KZT</option>
                            <option value="EUR">EUR</option>
                            <option value="TRY">TRY</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">USD ekvivalenti</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                            <input type="number" id="amountUsd" step="0.01" placeholder="0.00"
                                   class="w-full bg-blue-50/50 border-none ring-1 ring-blue-100 rounded-2xl p-3.5 pl-7 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all font-bold text-blue-600"
                                   required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Sana</label>
                        <input type="date" id="expenseDate"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer"
                               required>
                    </div>
                </div>

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Tavsif (ixtiyoriy)</label>
                    <textarea id="description"
                              class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none"
                              rows="2" placeholder="Xarajat haqida izoh..."></textarea>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeModal()"
                            class="flex-1 py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold hover:bg-gray-200 transition-all active:scale-95">
                        Bekor qilish
                    </button>
                    <button type="submit"
                            class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-xl shadow-blue-100 transition-all active:scale-95">
                        Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="truckExpenseModal"
     class="fixed inset-0 z-[150] hidden overflow-y-auto backdrop-blur-sm bg-black/40 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white w-full max-w-md shadow-2xl rounded-[32px] border border-gray-100 p-8">

            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900 tracking-tight">üîß Mashina xarajati</h3>
                <button type="button" onclick="closeTruckExpenseModal()"
                        class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="truckExpenseForm" class="space-y-6">
                <input type="hidden" id="teTripId">
                <input type="hidden" id="teTruckId">

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Xarajat turi</label>
                    <select id="teType"
                            class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer"
                            required>
                        <option value="TIRE">üßø Balon (Tire)</option>
                        <option value="OIL_CHANGE">üõ¢Ô∏è Moy almashtirish</option>
                        <option value="FILTER">üå™Ô∏è Filtr</option>
                        <option value="BRAKE_REPAIR">üõë Tormoz ta'miri</option>
                        <option value="ENGINE_REPAIR">‚öôÔ∏è Dvigatel ta'miri</option>
                        <option value="WASH">üßº Yuvish</option>
                        <option value="TECH_INSPECTION">üìù Texosmot</option>
                        <option value="INSURANCE">üõ°Ô∏è Sug'urta</option>
                        <option value="OTHER">üìÅ Boshqa</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Mahalliy summa</label>
                        <input type="number" id="teAmountLocal" step="0.01" placeholder="0.00"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                               required>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Valyuta</label>
                        <select id="teLocalCurrency"
                                class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer font-bold text-gray-700">
                            <option value="UZS">UZS</option>
                            <option value="USD">USD</option>
                            <option value="RUB">RUB</option>
                            <option value="KZT">KZT</option>
                            <option value="TRY">TRY</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">USD ekvivalenti</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                            <input type="number" id="teAmountUsd" step="0.01" placeholder="0.00"
                                   class="w-full bg-blue-50/50 border-none ring-1 ring-blue-100 rounded-2xl p-3.5 pl-7 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all font-bold text-blue-600"
                                   required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Sana</label>
                        <input type="date" id="teDate"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer"
                               required>
                    </div>
                </div>

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Tavsif (ixtiyoriy)</label>
                    <textarea id="teDescription"
                              class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none"
                              rows="2" placeholder="Xarajat haqida izoh..."></textarea>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeTruckExpenseModal()"
                            class="flex-1 py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold hover:bg-gray-200 transition-all active:scale-95">
                        Bekor qilish
                    </button>
                    <button type="submit"
                            class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-xl shadow-blue-100 transition-all active:scale-95">
                        Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="salaryModal"
     class="fixed inset-0 z-[150] hidden overflow-y-auto backdrop-blur-sm bg-black/40 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white w-full max-w-md shadow-2xl rounded-[32px] border border-gray-100 p-8">

            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900 tracking-tight">Oylik / To'lov yozish</h3>
                <button onclick="closeSalaryModal()"
                        class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="salaryForm" class="space-y-6">
                <input type="hidden" id="balanceUserId">
                <input type="hidden" id="balanceTripId">

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">To'lov turi</label>
                    <select id="paymentType"
                            class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-green-500 outline-none transition-all appearance-none cursor-pointer"
                            required>
                        <option value="SALARY">üí∞ Oylik (Salary)</option>
                        <option value="BONUS">üéÅ Bonus</option>
                        <option value="PENALTY">‚ö†Ô∏è Jarima (Penalty)</option>
                        <option value="ADVANCE">üí∏ Avans (Advance)</option>
                        <option value="PERSONAL">üë§ Shaxsiy (Personal)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Summa (USD)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                            <input type="number" id="balanceAmountUsd" step="0.01" placeholder="0.00"
                                   class="w-full bg-green-50/50 border-none ring-1 ring-green-100 rounded-2xl p-3.5 pl-7 text-sm focus:ring-2 focus:ring-green-500 outline-none transition-all font-bold text-green-600"
                                   required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Sana</label>
                        <input type="date" id="operationDate"
                               class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-green-500 outline-none transition-all cursor-pointer"
                               required>
                    </div>
                </div>

                <div class="flex items-center space-x-3 p-1">
                    <input type="checkbox" id="isPaid"
                           class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">
                    <label for="isPaid" class="text-sm font-medium text-gray-700">To'lov amalga oshirilgan (Is
                        Paid)</label>
                </div>

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Tavsif</label>
                    <textarea id="balanceDescription"
                              class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-green-500 outline-none transition-all resize-none"
                              rows="2" placeholder="Izoh yozing..." required></textarea>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeSalaryModal()"
                            class="flex-1 py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold hover:bg-gray-200 transition-all active:scale-95">
                        Bekor qilish
                    </button>
                    <button type="submit"
                            class="flex-1 py-4 bg-green-600 text-white rounded-2xl font-bold hover:bg-green-700 shadow-xl shadow-green-100 transition-all active:scale-95">
                        Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    const API_BASE = 'https://track-menegment-2.onrender.com/api/v1';
    // const API_BASE = 'http://localhost:8081/api/v1';
    let authToken = null;
    let currentUser = null;
    let currentUserFilter = 'DRIVER';
    let currentEditingUserRole = null;
    let currentEditingUserId = null;
    let allUsers = {drivers: [], managers: [], economists: []};
    let myChart = null; // Global o'zgaruvchi

    const showNotify = (title, text, icon = 'success') => {
        Swal.fire({
            title: title,
            text: text,
            icon: icon,
            timer: 2100,
            showConfirmButton: icon === 'error',
            position: 'center',
            // Apple Style sozlamalari
            background: 'rgba(255, 255, 255, 0.95)',
            backdrop: `rgba(0,0,0,0.1) blur(4px)`, // Orqa fonni xiralashtirish
            customClass: {
                popup: 'apple-popup',
                title: 'apple-title',
                htmlContainer: 'apple-text',
                confirmButton: 'apple-button',
                icon: 'apple-icon'
            },
            buttonsStyling: false, // Default dizaynni o'chiramiz
            showClass: {
                popup: 'animate__animated animate__fadeIn animate__faster' // Mayin ochilish
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOut animate__faster'
            }
        });
    };
    // Settings ichidagi sidebar almashtirish funksiyasi
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('sidebar-item')) {
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const sections = document.querySelectorAll('.settings-section');

            // Hammasini o'chirish
            sidebarItems.forEach(i => i.classList.remove('active'));
            sections.forEach(s => s.classList.remove('active'));

            // Tanlanganni yoqish
            e.target.classList.add('active');
            const sectionId = e.target.getAttribute('data-section');
            document.getElementById(sectionId).classList.add('active');
        }
    });

    function saveProfileSettings() {
        // Bu yerda API orqali profilni yangilash kodi bo'ladi
        showNotify("Muvaffaqiyatli", "Profil ma'lumotlari yangilandi", "success");
    }
    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });

            const data = await response.json();

            if (response.ok && data.token) {
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                await loadCurrentUser();
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showTab('dashboard');
            } else {
                document.getElementById('loginError').textContent = 'Login yoki parol xato!';
                document.getElementById('loginError').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Login error:', error);
            document.getElementById('loginError').textContent = 'Serverga ulanishda xatolik!';
            document.getElementById('loginError').classList.remove('hidden');
        }
    });
    // Fuel form submit
    document.getElementById('fuelForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Ma'lumotlarni yig'ish
        const tripId = parseInt(document.getElementById('fuelTripId').value);
        const truckId = parseInt(document.getElementById('fuelTruckId').value);
        const litres = parseFloat(document.getElementById('fuelLitres').value);
        const pricePerLitres = parseFloat(document.getElementById('fuelPricePerLitres').value);
        const localCurrency = document.getElementById('fuelLocalCurrency').value;
        const amountLocal = parseFloat(document.getElementById('fuelAmountLocal').value);
        const totalAmountUsd = parseFloat(document.getElementById('fuelTotalAmountUsd').value); // Qo'lda kiritilgan USD
        const gasStationName = document.getElementById('fuelGasStationName').value;
        const country = document.getElementById('fuelCountry').value;
        const fuelDate = document.getElementById('fuelDate').value;

        const payload = {
            tripId,
            truckId,
            litres,
            PricePerLitres: pricePerLitres, // Backend DTO ga mos ravishda
            localCurrency,
            amountLocal,
            totalAmountUsd,
            gasStationName,
            country,
            fuelDate
        };

        try {
            const response = await fetch(`${API_BASE}/fuel/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok || data.success) {
                showNotify("Muvaffaqiyatli!", "Yonilg‚Äòi muvaffaqiyatli qo‚Äòshildi!");
                closeFuelModal();
                if (typeof showTripDetails === "function") {
                    showTripDetails(tripId);
                }
            } else {
                showNotify("Xatolik!", data.message || "Xatolik yuz berdi", "error");
            }
        } catch (error) {
            console.error("POST Fuel xatolik:", error);
            showNotify("Muommo mavjud !", "Server bilan bog'lanishda xatolik yuz berdi!");
        }
    });

    document.getElementById('addTruckForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.buyPrice = parseFloat(data.buyPrice);
        data.manufactureYear = parseInt(data.manufactureYear);

        try {
            const response = await fetch(`${API_BASE}/truck/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showNotify("Muvaffaqiyatli !", 'Mashina muvaffaqiyatli qo\'shildi!');
                closeAddTruckModal();
                loadTrucks();
            } else {
                showNotify("Kutilmagan xatolik", 'Xatolik yuz berdi!');
            }
        } catch (error) {
            console.error('Error creating truck:', error);
            showNotify("Kutilmagan xatolik", 'Xatolik yuz berdi!');
        }
    });

    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        let data = Object.fromEntries(formData.entries());

        let url = '';
        let method = 'POST';

        if (currentEditingUserId) {
            // === Tahrirlash (UPDATE) ===
            method = 'PUT';
            url = `${API_BASE}/user/update/${currentEditingUserId}`;

            // Parol bo‚Äòsh bo‚Äòlsa yubormaymiz
            if (!data.password) {
                delete data.password;
            }
            // userType update da kerak emas
            delete data.userType;
        } else {
            // === Yangi qo‚Äòshish (CREATE) ===
            const userType = data.userType;
            if (!userType) {
                showNotify("Muommo mavjud!", 'Lavozim tanlang!');
                return;
            }
            delete data.userType;

            switch (userType) {
                case 'DRIVER':
                    url = `${API_BASE}/user/create-driver`;
                    break;
                case 'MANAGER':
                    url = `${API_BASE}/user/create-manager`;
                    break;
                case 'ECONOMIST':
                    url = `${API_BASE}/user/create-economist`;
                    break;
                default:
                    showNotify("Muommo mavjud!", 'Noto‚Äòg‚Äòri lavozim!');
                    return;
            }
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && (result.success || result.object)) {
                showNotify("Muvaffaqiyatli!", currentEditingUserId
                    ? 'Foydalanuvchi  yangilandi!'
                    : 'Foydalanuvchi  qo‚Äòshildi!');
                closeAddUserModal();
                loadAllUsers(); // ro‚Äòyxatni yangilaydi
            } else {
                showNotify("Muommo ", 'Xatolik: ' + (result.message || 'Noma ºlum xatolik'));
            }
        } catch (error) {
            console.error('Submit error:', error);
            showNotify("Muommo mavjud !", 'Serverga ulanishda xatolik!');
        }
    });

    document.getElementById('addTripForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        data.truckId = parseInt(data.truckId);
        data.driverId = parseInt(data.userId);
        data.incomeOutUsd = parseFloat(data.incomeOutUsd);
        data.incomeBackUsd = parseFloat(data.incomeBackUsd);
        data.driverIncomeUsd = parseFloat(data.driverIncomeUsd);
        data.tripDuration = parseInt(data.tripDuration) || 0;
        data.driverIncomePaid = false;
        data.tripStatus = 'IN_PROGRESS';
        data.finishedDate = '';

        try {
            const response = await fetch(`${API_BASE}/trip/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showNotify("Muvaffaqiyatli !", 'Reys  qo\'shildi!');
                closeAddTripModal();
                loadTrips();
            } else {
                showNotify("Kutilmagan xatolik", 'Xatolik yuz berdi!');
            }
        } catch (error) {
            console.error('Error creating trip:', error);
            showNotify("Kutilmagan xatolik", 'Xatolik yuz berdi!');
        }
    });

    async function loadCurrentUser() {
        try {
            const response = await fetch(`${API_BASE}/user/me`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });
            const data = await response.json();

            if (data.success) {
                currentUser = data.object;

                // Profil ma'lumotlarini to'ldirish
                document.getElementById('profileName').textContent = currentUser.fullName;
                document.getElementById('profileRole').textContent = currentUser.role;
                document.getElementById('profilePhone').textContent = currentUser.phoneNumber;
                document.getElementById('profileAddress').textContent = currentUser.address;

                // Ismning birinchi harfini ikonka uchun olish
                document.getElementById('userInitial').textContent = currentUser.fullName.charAt(0).toUpperCase();

                // Sozlamalar bo'limidagi ma'lumotlarni ham yangilash (agar kerak bo'lsa)
                const settingsDetails = document.getElementById('userDetails');
                if (settingsDetails) {
                    settingsDetails.innerHTML = `
                    <p><strong>Ism:</strong> ${currentUser.fullName}</p>
                    <p><strong>Lavozim:</strong> ${currentUser.role}</p>
                    <p><strong>Telefon:</strong> ${currentUser.phoneNumber}</p>
                    <p><strong>Manzil:</strong> ${currentUser.address}</p>
                `;
                }
            }
        } catch (error) {
            console.error('Error loading user:', error);
        }
    }

    function toggleProfileMenu() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('hidden');

        // Tashqariga bosganda yopilish mantig'i
        const closeMenu = (e) => {
            if (!e.target.closest('.relative')) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        };

        if (!dropdown.classList.contains('hidden')) {
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }
    }

    function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem('authToken');
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }

    function showTab(tabName) {
        // 1. Barcha tablarni yashirish (Hozir dashboard-tab ham yashiriladi)
        const tabs = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.classList.add('hidden');
        });

        // 2. Navigatsiya tugmalaridan aktiv rangni olib tashlash
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'bg-gray-100');
        });

        // 3. Tanlangan tabni ko'rsatish
        const selectedTab = document.getElementById(`${tabName}-tab`);
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
        }

        // 4. Tanlangan tugmani aktiv qilish
        const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeBtn) {
            activeBtn.classList.add('bg-blue-600', 'text-white');
        }

        // 5. Ma'lumotlarni yuklash (Faqat kerakli bo'lim yuklanadi)
        if (tabName === 'dashboard') loadDashboard();
        else if (tabName === 'users') loadAllUsers();
        else if (tabName === 'trucks') loadTrucks();
        else if (tabName === 'trips') loadTrips();
    }

    async function loadDashboard() {
        try {
            const [tripsRes, trucksRes, driversRes, managersRes, economistsRes] = await Promise.all([
                fetch(`${API_BASE}/trip/getAll`, {headers: {'Authorization': `Bearer ${authToken}`}}),
                // fetch(`${API_BASE}/truck/list-truck`, {headers: {'Authorization': `Bearer ${authToken}`}}),
                // fetch(`${API_BASE}/user/list-driver`, {headers: {'Authorization': `Bearer ${authToken}`}}),
                // fetch(`${API_BASE}/user/list-manager`, {headers: {'Authorization': `Bearer ${authToken}`}}),
                // fetch(`${API_BASE}/user/list-economist`, {headers: {'Authorization': `Bearer ${authToken}`}})
            ]);

            const trips = await tripsRes.json();
            const trucks = await trucksRes.json();
            const drivers = await driversRes.json();
            const managers = await managersRes.json();
            const economists = await economistsRes.json();

            if (trips.success) {
                document.getElementById('totalTrips').textContent = trips.object.length;
                document.getElementById('inProgressTrips').textContent =
                    trips.object.filter(t => t.tripStatus === 'IN_PROGRESS').length;
            }
            if (trucks.success) {
                document.getElementById('activeTrucks').textContent =
                    trucks.object.filter(t => t.truckStatus === 'ACTIVE').length;
            }

            let totalUsers = 0;
            if (drivers.success) totalUsers += drivers.object.length;
            if (managers.success) totalUsers += managers.object.length;
            if (economists.success) totalUsers += economists.object.length;
            document.getElementById('totalUsers').textContent = totalUsers;
            const ctx = document.getElementById('financeChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jami daromad', 'Xarajatlar', 'Sof foyda'],
                    datasets: [{
                        label: 'Summa ($)',
                        data: [18300, 6886, 7189], // Bu yerga API dan kelgan summalarni qo'ying
                        backgroundColor: ['#22c55e', '#ef4444', '#3b82f6'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false // Konteynerga moslashishi uchun
                }
            });

            // 2. Top Haydovchilar (Simulyatsiya)
            const driversList = document.getElementById('topDriversList');
            drivers.object.slice(0, 3).forEach((driver, index) => {
                driversList.innerHTML += `
            <div class="flex justify-between items-center p-2 border-b">
                <span>${index + 1}. ${driver.fullName}</span>
                <span class="font-bold text-green-600">$7189</span>
            </div>`;
            });
            const truckList = document.getElementById('truckStatusList');
            document.getElementById('topDriversList').innerHTML = ''; // Tozalash shart!
            document.getElementById('truckStatusList').innerHTML = ''; // Tozalash shart!
            trucks.object.slice(0, 4).forEach(truck => {
                const statusColor = truck.truckStatus === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700';
                truckList.innerHTML += `
            <div class="flex justify-between p-2 border rounded-lg">
                <div><p class="font-bold">${truck.truckNumber}</p><p class="text-xs text-gray-500">${truck.model}</p></div>
                <span class="px-2 py-1 rounded text-xs h-fit ${statusColor}">${truck.truckStatus}</span>
            </div>`;
            });
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    async function loadAllUsers() {
        try {
            const [driversRes, managersRes, economistsRes] = await Promise.all([
                fetch(`${API_BASE}/user/list-driver`, {headers: {'Authorization': `Bearer ${authToken}`}}),
                fetch(`${API_BASE}/user/list-manager`, {headers: {'Authorization': `Bearer ${authToken}`}}),
                fetch(`${API_BASE}/user/list-economist`, {headers: {'Authorization': `Bearer ${authToken}`}})
            ]);

            const drivers = await driversRes.json();
            const managers = await managersRes.json();
            const economists = await economistsRes.json();

            if (drivers.success) allUsers.drivers = drivers.object;
            if (managers.success) allUsers.managers = managers.object;
            if (economists.success) allUsers.economists = economists.object;

            filterUsers(currentUserFilter);
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function filterUsers(role) {
        currentUserFilter = role;

        document.querySelectorAll('.user-filter-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        document.querySelector(`[data-role="${role}"]`).classList.remove('bg-gray-200', 'text-gray-700');
        document.querySelector(`[data-role="${role}"]`).classList.add('bg-blue-600', 'text-white');

        let users = [];
        if (role === 'DRIVER') users = allUsers.drivers;
        if (role === 'MANAGER') users = allUsers.managers;
        if (role === 'ECONOMIST') users = allUsers.economists;

        const usersList = document.getElementById('usersList');
        usersList.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
        usersList.innerHTML = users.map(user => `
    <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="space-y-2">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">F.I.O</p>
                    <p class="font-bold text-lg text-gray-800 leading-tight">${user.fullName}</p>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Manzil va Yosh</p>
                    <p class="text-sm text-gray-600 font-medium">${user.address} | ${user.age} yosh</p>
                </div>
                <div class="flex gap-4">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Telefon</p>
                        <p class="text-sm text-gray-700 font-semibold">${user.phoneNumber}</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">PNFL</p>
                        <p class="text-sm text-gray-700 font-semibold tracking-tighter">${user.pnfl}</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-4">
                <span class="px-3 py-1 bg-blue-50 text-blue-600 border border-blue-100 rounded-md text-[10px] font-black uppercase tracking-widest">
                    ${user.role}
                </span>

                <div class="flex gap-2">
                    <button onclick="viewUser('${user.id}')"
                            class="p-2 text-blue-600 hover:bg-blue-600 hover:text-white rounded-lg transition-colors border border-blue-100 shadow-sm"
                            title="Batafsil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>

                    <button onclick="editUser('${user.id}')"
                            class="p-2 text-amber-600 hover:bg-amber-600 hover:text-white rounded-lg transition-colors border border-amber-100 shadow-sm"
                            title="Tahrirlash">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
`).join('');
    }

    // User Modal Functions
    function openAddUserModal() {
        // Modalni ochamiz
        document.getElementById('addUserModal').classList.add('active');

        // Formani tozalaymiz (barcha inputlar bo'sh bo'ladi)
        document.getElementById('addUserForm').reset();

        // Sarlavhani "Yangi qo'shish" holatiga qaytaramiz
        document.querySelector('#addUserModal h3').innerText = "Yangi foydalanuvchi qo'shish";

        // Lavozim tanlovini ochamiz va bo'sh qilamiz
        const userTypeSelect = document.querySelector('#addUserForm [name="userType"]');
        userTypeSelect.disabled = false;   // yangi qo‚Äòshishda tanlash ochiq bo‚Äòladi
        userTypeSelect.value = "";         // hech qanday tanlov bo‚Äòlmasin

        // Edit rejimi tozalanadi (agar oldin qolgan bo‚Äòlsa)
        currentEditingUserId = null;
        currentEditingUserRole = null;
    }

    async function editUser(userId) {
        // allUsers ob'ektidan foydalanuvchini topamiz (drivers, managers, economists)
        let user = null;
        let role = null;

        const roleMap = {
            drivers: 'DRIVER',
            managers: 'MANAGER',
            economists: 'ECONOMIST'
        };

        for (const key in roleMap) {
            user = allUsers[key].find(u => u.id == userId); // == ishlatdim, chunki id string bo‚Äòlishi mumkin
            if (user) {
                role = roleMap[key];
                break;
            }
        }

        if (!user) {
            showNotify("Muommo", 'Foydalanuvchi topilmadi!');
            return;
        }

        // O‚Äòzgaruvchilarga saqlaymiz
        currentEditingUserId = userId;
        currentEditingUserRole = role;

        // Modalni ochamiz
        document.getElementById('addUserModal').classList.add('active');

        // Sarlavhani o‚Äòzgartiramiz
        document.querySelector('#addUserModal h3').innerText = 'Foydalanuvchi ma ºlumotlarini tahrirlash';

        // Lavozimni tanlaymiz va disable qilamiz (o‚Äòzgartirish taqiqlanadi)
        const userTypeSelect = document.querySelector('#addUserForm [name="userType"]');
        userTypeSelect.value = role;
        userTypeSelect.disabled = true;

        // Formani to‚Äòldiramiz (mavjud fieldlar bo‚Äòyicha)
        document.querySelector('#addUserForm [name="fullName"]').value = user.fullName || '';
        document.querySelector('#addUserForm [name="phoneNumber"]').value = user.phoneNumber || '';
        document.querySelector('#addUserForm [name="passportNumber"]').value = user.passportNumber || '';
        document.querySelector('#addUserForm [name="pnfl"]').value = user.pnfl || '';
        document.querySelector('#addUserForm [name="address"]').value = user.address || '';
        document.querySelector('#addUserForm [name="password"]').value = ''; // parol bo‚Äòsh qoldiriladi

        // Tug‚Äòilgan sana va ishga kirgan sana listda yo‚Äòq ‚Üí bo‚Äòsh qoldiramiz
        // Agar backendda bu fieldlar majburiy bo‚Äòlmasa, muammo bo‚Äòlmaydi
        document.querySelector('#addUserForm [name="brithDate"]').value = user.brithDate || '';
        document.querySelector('#addUserForm [name="hireDate"]').value = user.hireDate || '';

    }

    function closeAddUserModal() {
        // Modalni yopamiz
        document.getElementById('addUserModal').classList.remove('active');

        // Formani tozalaymiz (barcha input, select, textarea bo'sh bo'ladi)
        document.getElementById('addUserForm').reset();

        // Sarlavhani asl holatga qaytaramiz
        document.querySelector('#addUserModal h3').innerText = "Yangi foydalanuvchi qo'shish";

        // Lavozim tanlovini ochamiz va bo'sh qilamiz
        const userTypeSelect = document.querySelector('#addUserForm [name="userType"]');
        userTypeSelect.disabled = false;   // tanlash ochiladi
        userTypeSelect.value = "";         // tanlov tozalanadi

        // Edit rejimi o'chiriladi
        currentEditingUserId = null;
        currentEditingUserRole = null;
    }

    // Truck Modal Functions
    function openAddTruckModal() {
        document.getElementById('addTruckModal').classList.add('active');
    }


    let isEditMode = false;
    let currentBalanceId = null;

    // Modalni ochish funksiyasi
    function openSalaryModal(userId, tripId = null, existingData = null) {
        const modal = document.getElementById('salaryModal');
        const form = document.getElementById('salaryForm');

        // Har safar ochilganda formani va holatni tozalash
        form.reset();
        isEditMode = false;
        currentBalanceId = null;

        // Yashirin maydonlarga qiymat berish
        document.getElementById('balanceUserId').value = userId;
        document.getElementById('balanceTripId').value = tripId || "";

        // Sanani bugungi kunga sozlash
        document.getElementById('operationDate').valueAsDate = new Date();
        const submitBtn = document.querySelector('#salaryForm button[type="submit"]');
        if (existingData) {
            // TAHRIRLASH REJIMI (Agar ma'lumot uzatilsa)
            isEditMode = true;
            currentBalanceId = existingData.id;
            document.getElementById('balanceAmountUsd').value = existingData.amountUsd;
            const typeSelect = document.getElementById('paymentType');
            typeSelect.value = existingData.paymentType;
            typeSelect.disabled = true; // Tahrirlashda o'zgartirib bo'lmaydi
            document.getElementById('balanceDescription').value = existingData.description;
            document.getElementById('operationDate').value = existingData.operationDate;

            const paidStatus = existingData.isPaid !== undefined ? existingData.isPaid : existingData.paid;
            document.getElementById('isPaid').checked = Boolean(paidStatus);

            document.querySelector('#salaryModal h3').innerText = "Balansni tahrirlash";
            typeSelect.style.background = "#f1f5f9"; // Vizual "yopiq" ekanini bildirish
            document.querySelector('#salaryModal h3').innerText = "Balansni tahrirlash";
            submitBtn.innerText = "O'zgarishlarni saqlash"; // Tahrirlash rejimi uchun
            submitBtn.classList.replace('btn-success', 'btn-primary'); // Rangini ham o'zgartirish mumkin
        } else {
            isEditMode = false;
            document.querySelector('#salaryModal h3').innerText = "Oylik / To'lov yozish";
            submitBtn.innerText = "Saqlash"; // Yangi qo'shish rejimi uchun
            submitBtn.classList.replace('btn-primary', 'btn-success');
            const typeSelect = document.getElementById('paymentType');
            typeSelect.disabled = false; // Yangi qo'shishda ochiq bo'ladi
            typeSelect.style.background = "#ffffff";
            document.getElementById('operationDate').valueAsDate = new Date();
            // YANGI QO'SHISH REJIMI
            document.getElementById('isPaid').checked = false; // Yangi qo'shishda bo'sh bo'ladi
            document.querySelector('#salaryModal h3').innerText = "Oylik / To'lov yozish";
        }
        // Modalni ko'rsatish
        modal.classList.remove('hidden');
    }

    // Formani yuborish (Submit)
    document.getElementById('salaryForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // userId raqam ko'rinishida bo'lishi shart
        const userId = parseInt(document.getElementById('balanceUserId').value);
        const tripIdValue = document.getElementById('balanceTripId').value;

        const data = {
            userId: userId,
            // tripId bo'sh bo'lsa yoki 0 bo'lsa null yuboramiz (Backendda ixtiyoriy)
            tripId: (tripIdValue && tripIdValue !== "0") ? parseInt(tripIdValue) : null,
            amountUsd: parseFloat(document.getElementById('balanceAmountUsd').value),
            paymentType: document.getElementById('paymentType').value,
            description: document.getElementById('balanceDescription').value,
            operationDate: document.getElementById('operationDate').value,
            isPaid: document.getElementById('isPaid').checked
        };

        // Tahrirlash yoki yangi qo'shish rejimini URL va Method bo'yicha aniqlash
        const url = isEditMode
            ? `${API_BASE}/user-balance/update/${currentBalanceId}`
            : `${API_BASE}/user-balance/add-balance`;

        const method = isEditMode ? 'PUT' : 'POST';

        // Tugmani vaqtincha faolsizlantirish (Double-click oldini olish)
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = true;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showNotify(
                    "Muvaffaqiyatli!",
                    isEditMode ? "Ma'lumot yangilandi!" : "To'lov muvaffaqiyatli qo'shildi!",
                    "success"
                );

                // Modalni yopish va formani tozalash
                closeSalaryModal();

                // Ma'lumotlarni qayta yuklash (UI yangilash)
                if (typeof viewUser === "function") {
                    await viewUser(userId);
                }

                // Agar moliya ro'yxati alohida bo'lsa, uni ham yangilash
                if (typeof updateFinanceDisplay === "function") {
                    updateFinanceDisplay(userId);
                }

            } else {
                // Backend validatsiya xatolarini ko'rsatish
                showNotify("Xato!", result.message || "Ma'lumot saqlanmadi", "error");
            }
        } catch (error) {
            console.error('Submit Error:', error);
            showNotify("Xato!", "Server bilan aloqa uzildi", "error");
        } finally {
            if (submitBtn) submitBtn.disabled = false;
        }
    });

    function closeSalaryModal() {
        const modal = document.getElementById('salaryModal');
        modal.classList.add('hidden');

        // Formani tozalash
        document.getElementById('salaryForm').reset();

        // Yashirin ID larni ham qo'lda tozalash (reset bularni doim ham tozalamaydi)
        document.getElementById('balanceUserId').value = "";
        document.getElementById('balanceTripId').value = "";
        currentBalanceId = null;
        isEditMode = false;
    }


    function closeAddTruckModal() {
        document.getElementById('addTruckModal').classList.remove('active');
        document.getElementById('addTruckForm').reset();
    }

    async function loadTrucks() {
        try {
            const response = await fetch(`${API_BASE}/truck/list-truck`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });
            const data = await response.json();

            if (data.success) {
                const trucksList = document.getElementById('trucksList');
                trucksList.className = "grid grid-cols-2 gap-4"; // 2 ustunli va orasi ochiq
                trucksList.innerHTML = data.object.map(truck => `
    <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="space-y-2">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Davlat raqami</p>
                    <p class="font-bold text-xl text-blue-600">${truck.truckNumber}</p>
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Model va Yili</p>
                    <p class="text-gray-700 font-semibold">${truck.modelName} <span class="text-gray-400">(${truck.manufactureYear})</span></p>
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Sotib olingan narxi</p>
                    <p class="text-sm font-bold text-gray-800">$${truck.buyPrice.toLocaleString()}</p>
                </div>
            </div>

            <div class="flex flex-col items-end gap-4">
                <div class="flex gap-2">
                    <button onclick="viewTruck('${truck.id}')"
                            class="p-2 text-blue-600 hover:bg-blue-600 hover:text-white rounded-lg transition-colors border border-blue-100 shadow-sm"
                            title="Batafsil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>

                    <button onclick="editTruck('${truck.id}')"
                            class="p-2 text-amber-600 hover:bg-amber-600 hover:text-white rounded-lg transition-colors border border-amber-100 shadow-sm"
                            title="Tahrirlash">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>

                <span class="px-3 py-1 rounded-md text-[10px] font-black uppercase tracking-widest border ${
                    truck.truckStatus === 'ACTIVE' ? 'bg-green-50 text-green-600 border-green-200' :
                        truck.truckStatus === 'REPAIR' ? 'bg-amber-50 text-amber-600 border-amber-200' :
                            'bg-red-50 text-red-600 border-red-200'
                }">
                    ${truck.truckStatus}
                </span>
            </div>
        </div>
    </div>
`).join('');
            }
        } catch (error) {
            console.error('Error loading trucks:', error);
        }
    }

    function addFuel(tripId, truckId) {
        document.getElementById('fuelForm').reset();

        document.getElementById('fuelTripId').value = tripId;
        document.getElementById('fuelTruckId').value = truckId;

        document.getElementById('fuelModal').classList.remove('hidden');
    }
    // Formani yuborish
    document.getElementById('expenseForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Tugmani bloklash (Double click oldini olish)
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerText;
        submitBtn.disabled = true;
        submitBtn.innerText = "Saqlanmoqda...";

        // Ma'lumotlarni yig'ish (Sizning fuelForm uslubingizda)
        const tripId = parseInt(document.getElementById('tripIdField').value);
        const type = document.getElementById('type').value;
        const amountLocal = parseFloat(document.getElementById('amountLocal').value);
        const localCurrency = document.getElementById('localCurrency').value;
        const amountUsd = parseFloat(document.getElementById('amountUsd').value);
        const description = document.getElementById('description').value;
        const expenseDate = document.getElementById('expenseDate').value;

        const payload = {
            tripId,
            type,
            amountLocal,
            localCurrency,
            amountUsd,
            description,
            expenseDate
        };

        try {
            const response = await fetch(`${API_BASE}/trip-expense/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}` // Tokenni ham qo'shdik
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok || data.success) {
                showNotify("Muvaffaqiyatli!", "Xarajat muvaffaqiyatli qo‚Äòshildi!");

                // Formani tozalash va modalni yopish
                closeModal();

                // Agar asosiy oynadagi ma'lumotlarni yangilash funksiyasi bo'lsa
                if (typeof showTripDetails === "function") {
                    showTripDetails(tripId);
                }
            } else {
                showNotify("Xatolik!", data.message || "Xatolik yuz berdi", "error");
            }
        } catch (error) {
            console.error("POST TripExpense xatolik:", error);
            showNotify("Muammo mavjud!", "Server bilan bog'lanishda xatolik yuz berdi!", "error");
        } finally {
            // Har qanday holatda ham tugmani qayta aktivlashtirish
            submitBtn.disabled = false;
            submitBtn.innerText = originalBtnText;
        }
    });

    // Modalni yopish
    function closeFuelModal() {
        document.getElementById('fuelForm').reset();
        document.getElementById('fuelModal').classList.add('hidden');
    }

    function addTripExpense(tripId) {
        const modal = document.getElementById('expenseModal');
        document.getElementById('tripIdField').value = tripId;
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        modal.classList.remove('hidden');
    }

    // Modalni yopish va tozalash
    function closeModal() {
        document.getElementById('expenseModal').classList.add('hidden');
        document.getElementById('expenseForm').reset();
    }

    async function viewUser(userId) {
        try {
            // 1. Foydalanuvchi ma'lumotlarini olish
            const response = await fetch(`${API_BASE}/user/${userId}`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (!response.ok) throw new Error(`HTTP xatosi: ${response.status}`);
            const result = await response.json();
            if (!result.success || !result.object) return;

            const user = result.object;

            // 2. Balans statistikalarini olish
            let balance = {
                totalSalary: 0,
                totalPersonal: 0,
                totalAdvance: 0,
                totalPenalty: 0,
                totalPaid: 0,
                nowBalance: 0
            };

            try {
                const balanceRes = await fetch(`${API_BASE}/user-balance/total-balance-sta/${userId}`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });
                const balanceResult = await balanceRes.json();
                if (balanceResult.success && balanceResult.object) {
                    balance = balanceResult.object;
                }
            } catch (balanceError) {
                console.error('Balansni yuklashda xatolik:', balanceError);
            }

            // UI ni tozalash
            document.getElementById('usersHeader')?.classList.add('hidden');
            document.getElementById('userTypeTabs')?.classList.add('hidden');
            document.getElementById('usersList')?.classList.add('hidden');

            const detailsSection = document.getElementById('userDetailsSection');
            detailsSection.classList.remove('hidden');

            let roleTitle = user.role === 'DRIVER' ? 'Haydovchi' : 'Xodim';

            // HTML kontentini joylash
            detailsSection.innerHTML = `
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 20px; font-family: 'Outfit', sans-serif;">

        <div style="margin-bottom: 30px;">
            <button onclick="closeUserDetails()" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; color: #475569; cursor: pointer; font-weight: 500;">
                <span>‚Üê</span> Ortga
            </button>
        </div>

        <div class="driver-info-card" style="background: white; border-radius: 20px; padding: 40px; margin-bottom: 30px; border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                <h1 style="font-size: 28px; font-weight: 700; color: #1e293b;">${roleTitle} Ma'lumotlari</h1>
                <button onclick="editUser(${user.id})" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">‚úèÔ∏è Tahrirlash</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <span style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">F.I.O</span>
                    <span style="font-size: 18px; font-weight: 600; color: #1e293b;">${user.fullName || '-'}</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <span style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Telefon</span>
                    <span style="font-size: 18px; font-weight: 600; color: #1e293b;">${user.phoneNumber || '-'}</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <span style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Ishga kirgan sana</span>
                    <span style="font-size: 18px; font-weight: 600; color: #1e293b;">${user.hireDate || '-'}</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <span style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase;">Manzil</span>
                    <span style="font-size: 18px; font-weight: 600; color: #1e293b;">${user.address || '-'}</span>
                </div>
            </div>
        </div>

        <div style="background: white; border-radius: 20px; padding: 40px; margin-bottom: 30px; border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-size: 24px; font-weight: 700; color: #1e293b;">Hozirgi Balans</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 48px; font-weight: 800; color: #3b82f6; font-family: 'JetBrains Mono', monospace;">
                        $${(balance.nowBalance || 0).toLocaleString()}
                    </span>
                    <span style="font-size: 24px; color: #64748b; font-weight: 600;">USD</span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #f0fdf4; padding: 25px; border-radius: 16px; border-left: 5px solid #10b981;">
                    <div style="font-size: 14px; color: #166534; margin-bottom: 10px; font-weight: 600; text-transform: uppercase;">Jami Daromad</div>
                    <div style="font-size: 28px; font-weight: 700; color: #14532d;">$${(balance.totalSalary || 0).toLocaleString()}</div>
                </div>

                <div style="background: #fff1f2; padding: 25px; border-radius: 16px; border-left: 5px solid #ef4444;">
                    <div style="font-size: 14px; color: #991b1b; margin-bottom: 10px; font-weight: 600; text-transform: uppercase;">Jami Olingan Pul</div>
                    <div style="font-size: 28px; font-weight: 700; color: #7f1d1d;">$${(balance.totalPaid || 0).toLocaleString()}</div>
                </div>

                <div style="background: #fffbeb; padding: 25px; border-radius: 16px; border-left: 5px solid #f59e0b;">
                    <div style="font-size: 14px; color: #92400e; margin-bottom: 10px; font-weight: 600; text-transform: uppercase;">Umumiy Jarimalar</div>
                    <div style="font-size: 28px; font-weight: 700; color: #78350f;">$${(balance.totalPenalty || 0).toLocaleString()}</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <button onclick="toggleFinanceView(${user.id})" style="padding: 18px; border-radius: 12px; border: none; background: #3b82f6; color: white; font-weight: 600; cursor: pointer;">üí∞ Oyliklarni ko'rish</button>
                <button onclick="openSalaryModal(${user.id})" style="padding: 18px; border-radius: 12px; border: none; background: #10b981; color: white; font-weight: 600; cursor: pointer;">üéÅ Oylik yozish</button>
                <button onclick="showTripsView(${user.id})" style="padding: 18px; border-radius: 12px; border: none; background: #1a59b8; color: white; font-weight: 600; cursor: pointer;">üöö Reyslarni ko'rish</button>
            </div>
        </div>
   <div style="background: white; border-radius: 20px; padding: 30px; border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        <h2 id="dynamicTitle" style="font-size: 22px; font-weight: 700; color: #1e293b; margin: 0;">Moliya Tarixi</h2>

        <div style="display: flex; gap: 10px; align-items: center; justify-content: flex-end;">
            <select id="itemsPerPage" onchange="updateFinanceDisplay(${user.id})" style="padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 500; cursor: pointer; outline: none;">
                <option value="5">5 ta</option>
                <option value="10">10 ta</option>
                <option value="15">15 ta</option>
                <option value="all">Hammasi</option>
            </select>

            <div id="actionButtonsContainer" style="display: flex; gap: 10px; align-items: center;">

                <button onclick="toggleFinanceView(${user.id}, 'INCOME')" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" style="padding: 10px 15px; border-radius: 10px; border: 1px solid #10b981; background: #f0fdf4; color: #166534; font-weight: 600; cursor: pointer; transition: 0.2s;">‚ûï Kirimlar</button>

                <button onclick="toggleFinanceView(${user.id}, 'EXPENSE')" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" style="padding: 10px 15px; border-radius: 10px; border: 1px solid #ef4444; background: #fff1f2; color: #991b1b; font-weight: 600; cursor: pointer; transition: 0.2s;">‚ûñ Chiqimlar</button>

                <div style="position: relative;">
                    <button onclick="document.getElementById('reportDropdown').classList.toggle('hidden')" style="padding: 10px 15px; background: white; border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        üìä Hisobot ‚ñæ
                    </button>
                    <div id="reportDropdown" class="hidden" style="position: absolute; top: 45px; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000; min-width: 150px;">
                        <div onclick="downloadFinanceReport(${user.id}, 'pdf')" style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9;">PDF yuklash</div>
                        <div onclick="downloadFinanceReport(${user.id}, 'excel')" style="padding: 12px 15px; cursor: pointer;">Excel yuklash</div>
                    </div>
                </div>

            </div> </div>
    </div>

    <div id="dynamicListContainer" style="max-height: 500px; overflow-y: auto; padding-right: 5px; scrollbar-width: thin;">
    </div>
</div>
</div>
    `;

            // DEFAULT HOLATDA: Oyliklarni yuklaymiz (Reyslarni emas)
            toggleFinanceView(user.id);

        } catch (error) {
            console.error('Xatolik:', error);
        }
    }

    // REYSLARNI KO'RSATISH
    let allUserTrips = []; // Reyslarni vaqtincha saqlash uchun

    async function showTripsView(userId) {
        const title = document.getElementById('dynamicTitle');
        const container = document.getElementById('dynamicListContainer');
        const buttonsContainer = document.getElementById('actionButtonsContainer');
        const itemsSelect = document.getElementById('itemsPerPage');

        // Sarlavhani yangilash
        title.innerText = "Bajarilgan Reyslar";

        // Pagination select-ni yashirish
        if (itemsSelect) {
            itemsSelect.style.display = 'none';
        }

        // Moliya tugmalari o'rniga faqat Reys filtrlarini chizish
        buttonsContainer.innerHTML = `
        <button onclick="filterTrips('ALL', this)" class="trip-filter-btn" style="padding: 10px 18px; border-radius: 10px; border: none; background: #1e293b; color: white; font-weight: 700; font-size: 11px; cursor: pointer; transition: 0.2s; opacity: 1;">BARCHASI</button>
        <button onclick="filterTrips('COMPLETED', this)" class="trip-filter-btn" style="padding: 10px 18px; border-radius: 10px; border: 1px solid #10b981; background: #f0fdf4; color: #166534; font-weight: 700; font-size: 11px; cursor: pointer; transition: 0.2s; opacity: 0.6;">TUGALLANGAN</button>
        <button onclick="filterTrips('IN_PROGRESS', this)" class="trip-filter-btn" style="padding: 10px 18px; border-radius: 10px; border: 1px solid #3b82f6; background: #eff6ff; color: #1d4ed8; font-weight: 700; font-size: 11px; cursor: pointer; transition: 0.2s; opacity: 0.6;">JARAYONDA</button>
    `;

        container.innerHTML = `<div style="padding: 40px; text-align: center; color: #64748b; font-family: sans-serif;">üîÑ Reyslar yuklanmoqda...</div>`;

        try {
            const response = await fetch(`${API_BASE}/trip/user-trips/${userId}`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });
            const result = await response.json();

            // Backend formatiga qarab ma'lumotni olish
            allUserTrips = result.object || result || [];

            renderTripsList(allUserTrips);
        } catch (e) {
            console.error("Xatolik:", e);
            container.innerHTML = `<div style="color: #ef4444; padding: 20px; text-align: center; font-weight: bold;">Ma'lumot olishda xatolik yuz berdi!</div>`;
        }
    }

    function filterTrips(status, btn) {
        // Barcha filter tugmalarini xiralashtirish
        document.querySelectorAll('.trip-filter-btn').forEach(b => {
            b.style.opacity = "0.6";
        });

        // Tanlangan tugmani yorqin qilish
        btn.style.opacity = "1";

        // Filtrlash mantiqi
        const filtered = status === 'ALL' ? allUserTrips : allUserTrips.filter(t => t.tripStatus === status);
        renderTripsList(filtered);
    }

    function renderTripsList(trips) {
        const container = document.getElementById('dynamicListContainer');

        if (!trips || trips.length === 0) {
            container.innerHTML = `<div style="padding: 50px; text-align: center; color: #94a3b8; font-family: sans-serif;">Ushbu turdagi reyslar topilmadi.</div>`;
            return;
        }

        container.innerHTML = trips.map(trip => {
            const isComp = trip.tripStatus === 'COMPLETED';
            const statusText = isComp ? 'TUGALLANGAN' : 'JARAYONDA';
            const color = isComp ? '#10b981' : '#3b82f6';
            const totalIncome = (trip.incomeOutUsd || 0) + (trip.incomeBackUsd || 0);

            return `
        <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 12px; border: 1px solid #f1f5f9; border-left: 5px solid ${color}; display: flex; justify-content: space-between; align-items: center; font-family: sans-serif;">
            <div>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <span style="font-size: 11px; font-weight: 800; color: #cbd5e1;">#${trip.id}</span>
                    <span style="font-weight: 700; color: #1e293b; font-size: 15px;">${trip.routeFrom} ‚ûî ${trip.routeTo}</span>
                    <span style="font-size: 9px; font-weight: 800; padding: 2px 8px; border-radius: 20px; background: ${isComp ? '#f0fdf4' : '#eff6ff'}; color: ${color};">
                        ${statusText}
                    </span>
                </div>
                <div style="display: flex; gap: 15px; font-size: 12px; color: #64748b;">
                    <span>üöõ <b>${trip.truckNumber}</b></span>
                    <span>‚è± ${trip.tripDuration} kun</span>
                    <span>üì¶ <b style="color: #10b981;">$${trip.incomeOutUsd} / $${trip.incomeBackUsd}</b></span>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Jami Daromad</div>
                <div style="font-size: 20px; font-weight: 900; color: #1e293b;">$${totalIncome.toLocaleString()}</div>
            </div>
        </div>
        `;
        }).join('');
    }

    function getStatusStyle(status) {
        switch (status) {
            case 'COMPLETED':
                return { color: '#10b981', bgClass: 'bg-green-50', textClass: 'text-green-600' };
            case 'IN_PROGRESS':
                return { color: '#3b82f6', bgClass: 'bg-blue-50', textClass: 'text-blue-600' };
            default:
                return { color: '#f59e0b', bgClass: 'bg-yellow-50', textClass: 'text-yellow-600' };
        }
    }
    // OYLIK VA MOLIYAVIY MA'LUMOTLARNI KO'RSATISH
    // 1. Dastlab ma'lumotni saqlash uchun o'zgaruvchi
    let currentFinanceData = [];

    async function toggleFinanceView(userId, filterType = 'ALL') {
        const container = document.getElementById('dynamicListContainer');
        const title = document.getElementById('dynamicTitle');
        const buttonsContainer = document.getElementById('actionButtonsContainer');
        const itemsSelect = document.getElementById('itemsPerPage');

        // 1. Yashirilgan elementlarni qayta ko'rsatish
        if (itemsSelect) {
            itemsSelect.style.display = 'block'; // Paginationni ko'rsatish
        }

        // 2. Reys filtrlari o'rniga Moliya tugmalarini qaytarish
        if (buttonsContainer) {
            buttonsContainer.innerHTML = `
            <button onclick="toggleFinanceView(${userId}, 'INCOME')" style="padding: 10px 15px; border-radius: 10px; border: 1px solid #10b981; background: #f0fdf4; color: #166534; font-weight: 600; cursor: pointer; transition: 0.2s;">‚ûï Kirimlar</button>
            <button onclick="toggleFinanceView(${userId}, 'EXPENSE')" style="padding: 10px 15px; border-radius: 10px; border: 1px solid #ef4444; background: #fff1f2; color: #991b1b; font-weight: 600; cursor: pointer; transition: 0.2s;">‚ûñ Chiqimlar</button>
            <div style="position: relative;">
                <button onclick="document.getElementById('reportDropdown').classList.toggle('hidden')" style="padding: 10px 15px; background: white; border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    üìä Hisobot ‚ñæ
                </button>
                <div id="reportDropdown" class="hidden" style="position: absolute; top: 45px; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000; min-width: 150px;">
                    <div onclick="downloadFinanceReport(${userId}, 'pdf')" style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9;">PDF yuklash</div>
                    <div onclick="downloadFinanceReport(${userId}, 'excel')" style="padding: 12px 15px; cursor: pointer;">Excel yuklash</div>
                </div>
            </div>
        `;
        }

        // Sarlavhani tanlangan filtrga qarab o'zgartiramiz
        const titles = {
            'ALL': 'Moliya Tarixi',
            'INCOME': 'Kirimlar Tarixi',
            'EXPENSE': 'Chiqimlar Tarixi'
        };
        title.innerText = titles[filterType] || titles['ALL'];

        container.innerHTML = `<div style="padding: 30px; text-align: center; color: #64748b;">Yuklanmoqda...</div>`;

        try {
            const response = await fetch(`${API_BASE}/user-balance/view-list/${userId}`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });
            const result = await response.json();

            if (!result.success || !result.object || result.object.length === 0) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: #94a3b8; background: #f8fafc; border-radius: 12px; margin-top: 10px;">Ma'lumotlar topilmadi.</div>`;
                return;
            }

            let data = result.object;
            if (filterType === 'INCOME') {
                data = data.filter(i => ['SALARY', 'BONUS'].includes(i.paymentType));
            } else if (filterType === 'EXPENSE') {
                data = data.filter(i => ['ADVANCE', 'PENALTY', 'PERSONAL'].includes(i.paymentType));
            }

            currentFinanceData = data;
            updateFinanceDisplay(userId);

        } catch (e) {
            container.innerHTML = `<div style="color: #ef4444; padding: 20px; text-align: center;">Ma'lumotni yuklashda xatolik yuz berdi.</div>`;
        }
    }

    function updateFinanceDisplay(userId) {
        const container = document.getElementById('dynamicListContainer');
        const limitElement = document.getElementById('itemsPerPage');
        const limit = limitElement ? limitElement.value : '5';

        const displayData = limit === 'all' ? currentFinanceData : currentFinanceData.slice(0, parseInt(limit));

        if (displayData.length === 0) {
            container.innerHTML = `<div style="padding: 40px; text-align: center; color: #94a3b8;">Ma'lumotlar topilmadi.</div>`;
            return;
        }

        container.innerHTML = displayData.map(item => {
            const config = {
                'SALARY': {label: 'Oylik', color: '#3b82f6', icon: 'üí∞'},
                'BONUS': {label: 'Bonus', color: '#10b981', icon: 'üéÅ'},
                'ADVANCE': {label: 'Avans', color: '#f97316', icon: 'üí∏'},
                'PERSONAL': {label: 'Shaxsiy', color: '#8b5cf6', icon: 'üë§'},
                'PENALTY': {label: 'Jarima', color: '#ef4444', icon: '‚ö†Ô∏è'}
            }[item.paymentType] || {label: item.paymentType, color: '#64748b', icon: 'üìÑ'};

            const isAlwaysPaid = ['PERSONAL', 'PENALTY', 'ADVANCE'].includes(item.paymentType);
            const isPaid = isAlwaysPaid || item.paid === true || item.isPaid === true;

            const statusHtml = isPaid
                ? `<span style="font-size: 11px; color: #10b981; background: #f0fdf4; padding: 2px 8px; border-radius: 6px; font-weight: 600; margin-left: 8px;">‚úÖ To'langan</span>`
                : `<span style="font-size: 11px; color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 6px; font-weight: 600; margin-left: 8px;">‚è≥ Kutilmoqda</span>`;

            const tripHtml = (item.tripId && item.tripId !== 0)
                ? `<span style="font-size: 12px; color: #3b82f6; background: #eff6ff; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 10px;">üöö Reys #${item.tripId}</span>`
                : '';

            return `
        <div style="background: white; border-radius: 12px; padding: 18px; border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 48px; height: 48px; background: ${config.color}15; color: ${config.color}; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                    ${config.icon}
                </div>
                <div>
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                        <span style="font-weight: 700; color: #1e293b; font-size: 16px;">${config.label}</span>
                        ${statusHtml}
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
                        üìÖ ${item.operationDate || '-'} ${tripHtml}
                    </div>
                    <div style="font-size: 13px; color: #64748b; margin-top: 4px; max-width: 400px;">${item.description || 'Izoh yo\'q'}</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="text-align: right; margin-right: 10px;">
                    <div style="font-size: 19px; font-weight: 800; color: #1e293b;">$${(item.amountUsd || 0).toLocaleString()}</div>
                    <div style="font-size: 10px; color: #94a3b8; font-weight: 700;">USD</div>
                </div>
                <button onclick='openSalaryModal(${userId}, null, ${JSON.stringify(item)})' style="background: #f8fafc; border: 1px solid #e2e8f0; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;">‚úèÔ∏è</button>
                <button onclick='deleteFinanceItem(${item.id}, ${userId})' style="background: #fff1f2; border: 1px solid #fecaca; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;">üóëÔ∏è</button>
            </div>
        </div>`;
        }).join('');
    }

    // O'chirish funksiyasi namunasi
    async function deleteFinanceItem(id, userId) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "Ushbu moliya yozuvini o'chirishni tasdiqlaysizmi? Uni qayta tiklab bo'lmasligi mumkin!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444', // O'chirish bo'lgani uchun qizilroq rang
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Ha, o‚Äòchirilsin!',
            cancelButtonText: 'Bekor qilish'
        }).then(async (result) => {

            if (!result.isConfirmed) return;

            let response;

            // üîπ 1. Tarmoq so'rovi (Fetch)
            try {
                response = await fetch(`${API_BASE}/user-balance/delete/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (networkError) {
                console.error("NETWORK ERROR:", networkError);
                showNotify("Tarmoq xatosi!", "Server bilan aloqa uzildi.", 'error');
                return;
            }

            // üîπ 2. HTTP statusni tekshirish
            if (!response.ok) {
                showNotify(
                    "Xatolik!",
                    `Serverda xatolik yuz berdi: ${response.status}`,
                    'error'
                );
                return;
            }

            // üîπ 3. JSON parsing (Xavfsiz usulda)
            let data;
            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : { success: true };
            } catch (jsonError) {
                console.warn("JSON parse xatosi:", jsonError);
                data = { success: true }; // Agar bo'sh qaytsa, muvaffaqiyatli deb hisoblaymiz
            }

            // üîπ 4. Biznes mantiq (data.success)
            if (data.success) {
                showNotify(
                    "O'chirildi!",
                    data.message || "Moliya yozuvi muvaffaqiyatli o'chirildi.",
                    'success'
                );

                // üîπ 5. UI ni yangilash
                try {
                    // Ro'yxatni qayta yuklash
                    toggleFinanceView(userId);
                } catch (uiError) {
                    console.error("UI yangilashda xatolik:", uiError);
                }

            } else {
                showNotify(
                    "Xatolik!",
                    data.message || "O'chirish imkoni bo'lmadi.",
                    'error'
                );
            }
        });
    }

    // HISOBOT YUKLASH FUNKSIYASI (AXLOQIY)
    async function downloadFinanceReport(userId) {
        try {
            const response = await fetch(`${API_BASE}/user-balance/get-report-pdf/${userId}`, {
                method: 'GET',
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            if (!response.ok) throw new Error("Serverdan javob bo'lmadi");

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `hisobot_${userId}.pdf`);
            document.body.appendChild(link);
            link.click();

            // Tozalash
            window.URL.revokeObjectURL(url);
            link.remove();

        } catch (error) {
            console.error("Yuklashda xatolik:", error);
            showNotify("Xatolik", "Hisobotni yuklab bo'lmadi.");
        }
    }

    function closeUserDetails() {
        const detailsSection = document.getElementById('userDetailsSection');
        if (detailsSection) detailsSection.classList.add('hidden');

        const usersHeader = document.getElementById('usersHeader');
        const userTypeTabs = document.getElementById('userTypeTabs');
        const usersList = document.getElementById('usersList');

        if (usersHeader) usersHeader.classList.remove('hidden');
        if (userTypeTabs) userTypeTabs.classList.remove('hidden');
        if (usersList) usersList.classList.remove('hidden');
    }

    // Trip Modal Functions
    function openAddTripModal() {
        loadTripFormData();
        document.getElementById('addTripModal').classList.add('active');
    }

    function closeAddTripModal() {
        document.getElementById('addTripModal').classList.remove('active');
        document.getElementById('addTripForm').reset();
    }

    async function loadTripFormData() {
        try {
            const [trucksRes, driversRes] = await Promise.all([
                fetch(`${API_BASE}/truck/list-truck`, {headers: {'Authorization': `Bearer ${authToken}`}}),
                fetch(`${API_BASE}/user/list-driver`, {headers: {'Authorization': `Bearer ${authToken}`}})
            ]);

            const trucks = await trucksRes.json();
            const drivers = await driversRes.json();

            if (trucks.success) {
                const truckSelect = document.getElementById('tripTruckSelect');
                truckSelect.innerHTML = '<option value="">Tanlang</option>' +
                    trucks.object.map(t => `<option value="${t.id}">${t.truckNumber} - ${t.modelName}</option>`).join('');
            }

            if (drivers.success) {
                const driverSelect = document.getElementById('tripDriverSelect');
                driverSelect.innerHTML = '<option value="">Tanlang</option>' +
                    drivers.object.map(d => `<option value="${d.id}">${d.fullName}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading trip form data:', error);
        }
    }

    async function loadTrips() {
        try {
            const response = await fetch(`${API_BASE}/trip/getAll`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            const data = await response.json();

            if (!data.success) return;

            const tripsList = document.getElementById('tripsList');
            tripsList.className = "grid grid-cols-1 lg:grid-cols-2 gap-4";
            tripsList.innerHTML = data.object.map(trip => {
                const statusLabels = {
                    'IN_PROGRESS': 'Jarayonda',
                    'WAITING_CONFIRMATION': 'Kutilmoqda',
                    'COMPLETED': 'Tugatilgan'
                };

                // F.I.O dan faqat ismni ajratib olish (2-so'zni oladi)
                // Agar F.I.O bo'sh bo'lsa yoki bitta so'z bo'lsa, borini chiqaradi
                const firstName = trip.fullName ? (trip.fullName.split(' ')[1] || trip.fullName.split(' ')[0]) : "Noma'lum";

                return `
    <div class="bg-white border border-gray-100 rounded-2xl p-5 hover:shadow-md transition-all duration-300 relative overflow-hidden group">
        <div class="absolute left-0 top-0 bottom-0 w-1 ${
                    trip.tripStatus === 'IN_PROGRESS' ? 'bg-blue-300' :
                        trip.tripStatus === 'WAITING_CONFIRMATION' ? 'bg-amber-300' :
                            'bg-green-300'
                }"></div>

        <div class="flex justify-between items-center pl-2">
            <div class="space-y-4">
                <div class="flex items-center gap-3">
                    <span class="bg-slate-50 text-slate-400 text-[10px] font-bold px-2 py-0.5 rounded border border-slate-100">
                        #${trip.id}
                    </span>
                    <p class="font-bold text-lg text-slate-600 tracking-tight">
                        ${trip.routeFrom} <span class="text-slate-300 mx-1">‚Üí</span> ${trip.routeTo}
                    </p>
                </div>

                <div class="flex items-center gap-6">
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">Haydovchi</p>
                        <span class="text-blue-500 font-bold text-xs bg-blue-50/40 px-3 py-1 rounded-md border border-blue-100/50 block shadow-sm">
                            üë§ ${firstName}
                        </span>
                    </div>
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">Mashina</p>
                        <span class="text-indigo-500 font-bold text-xs bg-indigo-50/40 px-3 py-1 rounded-md border border-indigo-100/50 block shadow-sm">
                            üöõ ${trip.truckNumber}
                        </span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-5">
                <span class="px-2 py-0.5 rounded-md text-[9px] font-bold uppercase tracking-wider border ${
                    trip.tripStatus === 'IN_PROGRESS' ? 'bg-blue-50/50 text-blue-400 border-blue-100' :
                        trip.tripStatus === 'WAITING_CONFIRMATION' ? 'bg-amber-50/50 text-amber-500 border-amber-100' :
                            'bg-green-50/50 text-green-500 border-green-100'
                }">
                    ${statusLabels[trip.tripStatus] || trip.tripStatus}
                </span>

                <button onclick="showTripDetails(${trip.id})"
                        class="p-2.5 bg-white border border-blue-100 rounded-xl text-blue-500 hover:bg-blue-50 transition-colors shadow-sm shadow-blue-50/50"
                        title="Batafsil">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    `;
            }).join('');

        } catch (error) {
            console.error('Error loading trips:', error);
        }
    }

    // Trip Details (INLINE, MODAL EMAS)
    async function showTripDetails(tripId) {
        try {
            const response = await fetch(`${API_BASE}/trip/${tripId}`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });

            const data = await response.json();
            if (!data.success) return;

            const trip = data.object;

            // Status COMPLETED bo'lsa tahrirlash bloklanadi
            const isLocked = trip.tripStatus === 'COMPLETED';
            const hideIfLocked = isLocked ? 'hidden' : '';

            // Statuslarni o'zbekchalashtirish va rang berish
            const statusMap = {
                'IN_PROGRESS': {label: 'Jarayonda', class: 'bg-green-100 text-green-700 ring-green-200'},
                'COMPLETED': {label: 'Tugatilgan', class: 'bg-blue-100 text-blue-700 ring-blue-200'}
            };
            const currentStatus = statusMap[trip.tripStatus] || {
                label: trip.tripStatus,
                class: 'bg-gray-100 text-gray-700 ring-gray-200'
            };

            document.getElementById('tripsList').classList.add('hidden');
            const detailsSection = document.getElementById('tripDetailsSection');

            detailsSection.innerHTML = `
<div class="bg-[#f2f2f7] min-h-screen p-4 md:p-6 font-sans antialiased text-[#1c1c1e]">
    <div class="max-w-7xl mx-auto bg-white rounded-[32px] shadow-sm border border-gray-200/50 p-6 md:p-8">

        <div class="flex justify-between items-center mb-6">
            <div class="flex gap-3">
                <button onclick="closeTripDetails()" class="px-5 py-2.5 bg-gray-100 hover:bg-gray-200 rounded-2xl text-[13px] font-bold transition-all active:scale-95 text-gray-600">
                    ‚Üê Ortga
                </button>
                <button onclick="printTripCheck(${trip.id})" class="px-5 py-2.5 bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 rounded-2xl text-[13px] font-bold transition-all flex items-center gap-2">
                    üñ®Ô∏è Chek chiqarish
                </button>
            </div>
            <div class="flex items-center gap-3">
                <h3 class="text-xl font-bold text-slate-800 tracking-tight">Reys Ma'lumotlari</h3>
                ${isLocked ? '<span class="px-3 py-1 bg-orange-50 text-orange-600 rounded-lg text-[10px] font-bold border border-orange-100">‚åõ TASDIQ KUTILMOQDA</span>' : ''}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

            <div class="bg-[#f2f7ff] rounded-[24px] p-7 border border-[#d1e3ff] shadow-sm">
                <h4 class="text-2xl font-bold text-blue-700 mb-8 tracking-tight flex items-center gap-3">
                    ${trip.routeFrom} <span class="text-blue-300 font-light">‚Üí</span> ${trip.routeTo}
                </h4>

                <div class="grid grid-cols-2 gap-y-8">
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Mashina raqami</span>
                        <span class="text-lg font-bold text-slate-700 tracking-tight uppercase">${trip.truckNumber}</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Mas'ul haydovchi</span>
                        <span class="text-lg font-bold text-slate-700 tracking-tight">${trip.driverFullName}</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Hozirgi holat</span>
                        <div>
                            <span class="px-3 py-1 ${currentStatus.class} rounded-lg text-[10px] font-bold uppercase tracking-wide ring-1 shadow-sm">
                               ‚óè ${currentStatus.label}
                            </span>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Safar davomiyligi</span>
                        <span class="text-lg font-bold text-slate-700 tracking-tight">${trip.tripDuration} kun</span>
                    </div>
                    <div class="flex flex-col border-t border-blue-50 pt-3">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Boshlanish sanasi</span>
                        <span class="text-[14px] font-semibold text-slate-500 tracking-tight">${trip.startedDate}</span>
                    </div>
                    <div class="flex flex-col border-t border-blue-50 pt-3">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Tugallanish sanasi</span>
                        <span class="text-[14px] font-semibold text-slate-500 tracking-tight">${trip.finishedDate || 'Hozirda'}</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="bg-[#f0fdf4] rounded-[24px] p-6 border border-green-100 shadow-sm">
                    <h5 class="text-[10px] font-bold text-green-700 uppercase tracking-widest mb-4 italic">Moliyaviy ko'rsatkichlar</h5>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center py-1.5 border-b border-green-50">
                            <span class="text-[13px] font-medium text-slate-500 italic">Ketish narxi:</span>
                            <span class="text-[15px] font-bold text-green-600 tracking-tighter">$${trip.incomeOutUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center py-1.5 border-b border-green-50">
                            <span class="text-[13px] font-medium text-slate-500 italic">Qaytish narxi:</span>
                            <span class="text-[15px] font-bold text-green-600 tracking-tighter">$${trip.incomeBackUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center pt-3">
                            <span class="text-lg font-bold text-slate-700 italic uppercase tracking-tight">Jami tushum:</span>
                            <span class="text-2xl font-bold text-slate-800 tracking-tighter">$${trip.totalIncomeUsd.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-[#fff1f2] rounded-[24px] p-6 border border-red-100 shadow-sm">
                    <h5 class="text-[10px] font-bold text-red-700 uppercase tracking-widest mb-4 italic text-red-700">Xarajatlar tarkibi</h5>
                    <div class="grid grid-cols-2 gap-x-8 gap-y-2">
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Yoqilg'i:</span>
                            <span class="text-[12px] font-bold text-red-600 tracking-tight">$${trip.totalFuelCostUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Ta'mir:</span>
                            <span class="text-[12px] font-bold text-red-600 tracking-tight">$${trip.truckExpensesTotalUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Yo'l haqi:</span>
                            <span class="text-[12px] font-bold text-red-600 tracking-tight">$${trip.totalTripExpensesUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Oylik:</span>
                            <span class="text-[12px] font-bold text-slate-600 tracking-tight">$${trip.driverIncomeUsd.toFixed(2)}</span>
                        </div>
                         <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-orange-400 italic">Shaxsiy:</span>
                            <span class="text-[12px] font-bold text-orange-600 tracking-tight">-$${(trip.personalExpenseDriver || 0).toFixed(2)}</span>
                        </div>
                         <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-bold text-blue-600 italic">Sof oylik:</span>
                            <span class="text-[12px] font-bold text-blue-700 tracking-tight">$${(trip.driverIncomeUsd - (trip.personalExpenseDriver || 0)).toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4">
                        <span class="text-[13px] font-bold text-slate-600 uppercase italic tracking-wide">Umumiy xarajat:</span>
                        <span class="text-xl font-bold text-red-600 tracking-tighter">${trip.totalExpense}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-blue-700 to-blue-900 rounded-[24px] p-6 mb-10 shadow-xl shadow-blue-100 flex justify-between items-center relative overflow-hidden">
            <div class="absolute right-0 top-0 opacity-10 scale-150 pointer-events-none text-8xl">üí∞</div>
            <div>
                <p class="text-[10px] font-bold text-blue-200 uppercase tracking-[0.2em] italic mb-1">Reysdan qolgan Sof Foyda</p>
                <h2 class="text-5xl font-bold text-white tracking-tighter">$${trip.profitUsd.toFixed(2)}</h2>
            </div>
            <div class="text-right hidden md:block border-l border-blue-400/30 pl-6">
                <p class="text-[10px] text-blue-100 uppercase font-bold tracking-tighter leading-tight italic">
                    Barcha operatsion xarajatlar va<br>oyliklar chegirilgan yakuniy foyda
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">‚õΩ Yonilg'i sarfi</h5>
                    <button onclick="addFuel(${trip.id}, ${trip.truckId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    ${trip.fuelEntries?.length > 0 ? trip.fuelEntries.map(fuel => `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl group hover:bg-white border border-transparent hover:border-blue-100 transition-all">
                            <div>
                                <p class="font-bold text-slate-700 text-[13px] tracking-tight">${fuel.gasStationName}</p>
                                <p class="text-[10px] text-gray-400 font-semibold uppercase tracking-tighter">${fuel.location} | ${fuel.fuelDate}</p>
                            </div>
                            <div class="text-right flex items-center gap-4">
                                <div>
                                    <p class="font-bold text-blue-600 text-[14px] tracking-tight">$${fuel.totalAmountUsd.toFixed(2)}</p>
                                    <p class="text-[9px] text-gray-400 font-bold uppercase">${fuel.liters}L</p>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editFuel(${fuel.id})" class="hover:bg-blue-50 p-2 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteFuel(${fuel.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-2 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold">
                     <span class="text-gray-400 text-[10px] uppercase italic tracking-widest">Jami xarajat:</span>
                     <span class="text-xl text-slate-800 tracking-tighter">$${trip.totalFuelCostUsd.toFixed(2)}</span>
                     <span class="text-xl text-slate-800 tracking-tighter">${trip.totalLiters} L</span>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">üí≥ Yo'l xarajatlari</h5>
                    <button onclick="addTripExpense(${trip.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    ${trip.tripExpenseResDto?.length > 0 ? trip.tripExpenseResDto.map(exp => `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl group hover:bg-white border border-transparent hover:border-red-100 transition-all">
                            <div>
                                <p class="font-bold text-slate-700 text-[13px] uppercase italic tracking-tight">${exp.type}</p>
                                <p class="text-[10px] text-gray-400 font-semibold tracking-tighter uppercase">${exp.expenseDate}</p>
                            </div>
                            <div class="text-right flex items-center gap-4">
                                <p class="font-bold text-red-600 text-[14px] tracking-tight">$${exp.amountUsd.toFixed(2)}</p>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editTripExpense(${exp.id})" class="hover:bg-blue-50 p-2 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteTripExpense(${exp.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-2 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold text-slate-800">
                     <span class="text-gray-400 text-[10px] uppercase italic tracking-widest">Jami summa:</span>
                     <span class="text-xl tracking-tighter">$${trip.totalTripExpensesUsd.toFixed(2)}</span>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">üîß Mashina ta'mirlash</h5>
                    <button onclick="addTruckExpense(${trip.id},${trip.truckId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    ${trip.truckExpenses?.length > 0 ? trip.truckExpenses.map(exp => `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl group hover:bg-white border border-transparent hover:border-orange-100 transition-all">
                            <span class="font-bold text-slate-700 text-[13px] tracking-tight">${exp.truckExpenseType}</span>
                            <div class="text-right flex items-center gap-4">
                                <span class="font-bold text-red-600 text-[14px] tracking-tight">$${exp.amountUsd.toFixed(2)}</span>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editTruckExpense(${exp.id})" class="hover:bg-blue-50 p-2 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteTruckExpense(${exp.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-2 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold">
                    <span class="text-gray-400 text-[10px] uppercase italic tracking-widest">Jami:</span>
                    <span class="text-xl text-slate-800 tracking-tighter">$${trip.truckExpensesTotalUsd.toFixed(2)}</span>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">üë§ Haydovchi balansi</h5>
                    <button onclick="openSalaryModal(${trip.driverId},${trip.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                    ${trip.userBalanceResponseList && trip.userBalanceResponseList.length > 0 ? trip.userBalanceResponseList.map(bal => `
                        <div class="flex justify-between items-center p-3 ${bal.paymentType === 'SALARY' ? 'bg-green-50' : 'bg-orange-50'} rounded-2xl group border border-transparent hover:border-gray-200 transition-all">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-gray-700 italic uppercase tracking-tighter">${bal.paymentType === 'SALARY' ? 'üí∞ OYLIK' : 'üõí SHAXSIY'}</span>
                                <span class="text-[9px] text-gray-400 italic truncate w-32">${bal.description || ''}</span>
                            </div>
                            <div class="text-right flex items-center gap-3">
                                <div>
                                    <p class="font-bold text-[13px] ${bal.paymentType === 'SALARY' ? 'text-green-600' : 'text-orange-600'} tracking-tight">
                                        ${bal.paymentType === 'SALARY' ? '+' : '-'}$${bal.amountUsd.toFixed(2)}
                                    </p>
                                    <p class="text-[8px] text-gray-400 font-bold uppercase">${bal.operationDate}</p>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editDriverBalance(${bal.id})" class="hover:bg-blue-50 p-1.5 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteDriverBalance(${bal.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-1.5 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t">
                    <button onclick="${isLocked ? '' : `toggleDriverPayment(${trip.id})`}"
                            class="w-full py-4 rounded-2xl font-bold text-[11px] tracking-[0.1em] shadow-md transition-all active:scale-95 ${
                trip.driverIncomePaid ? 'bg-green-500 text-white shadow-green-100' : 'bg-red-500 text-white shadow-red-100'
            }">
                        ${trip.driverIncomePaid ? '‚úÖ TO‚ÄòLANGAN' : '‚ùå TO‚ÄòLANMAGAN'}
                    </button>
                </div>
            </div>

        </div>

        <div class="mt-12 pt-8 border-t flex justify-center">
            <button onclick="updateTripStatus(${trip.id}, '${trip.tripStatus}')"
                    class="px-20 py-5 rounded-[24px] font-bold text-[13px] tracking-[0.15em] shadow-xl transition-all transform hover:scale-[1.02] active:scale-95 text-white ${
                isLocked ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-100' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-100'
            }">
                ${isLocked ? 'üîì TAHRIRLASHNI OCHISH' : '‚úÖ REYSNI TASDIQLASH VA YAKUNLASH'}
            </button>
        </div>
    </div>
</div>
`;

            detailsSection.classList.remove('hidden');
            detailsSection.scrollIntoView({behavior: 'smooth', block: 'start'});

        } catch (error) {
            console.error('Error:', error);
            showNotify("Xatolik", "Ma'lumotlarni yuklashda xatolik yuz berdi", "error");
        }
    }

    async function printTripCheck(tripId) {
        try {
            const response = await fetch(`${API_BASE}/trip/${tripId}`, {
                headers: {'Authorization': `Bearer ${authToken}`}
            });
            const data = await response.json();
            if (!data.success) return;

            const trip = data.object;
            const printContainer = document.createElement('div');
            printContainer.id = 'print-section';

            printContainer.innerHTML = `
        <div class="ticket">
            <div class="header">
                <h2>LOGISTICS CHECK</h2>
                <p>Sana: ${new Date().toLocaleString()}</p>
            </div>

            <div class="info">
                <div><b>Reys:</b> ${trip.routeFrom} - ${trip.routeTo}</div>
                <div><b>Mashina:</b> ${trip.truckNumber}</div>
                <div><b>Haydovchi:</b> ${trip.driverFullName}</div>
            </div>

            <div class="line"></div>

            <div class="stats">
                <div class="row"><span>Yoqilg'i (${trip.totalLiters || 0} L):</span> <b>$${(trip.totalFuelCostUsd || 0).toFixed(2)}</b></div>
                <div class="row"><span>Safar xarajatlari:</span> <b>$${(trip.totalTripExpensesUsd || 0).toFixed(2)}</b></div>
                <div class="row"><span>Mashina xarajatlari:</span> <b>$${(trip.truckExpensesTotalUsd || 0).toFixed(2)}</b></div>
            </div>

            <div class="driver-box">
                <div class="row"><span>Haydovchi oyligi:</span> <b>$${(trip.driverIncomeUsd || 0).toFixed(2)}</b></div>
                <div class="row red"><span>Shaxsiy xarajat:</span> <b>-$${(trip.personalExpenseDriver || 0).toFixed(2)}</b></div>
                <div class="row bold"><span>SOF OYLIK:</span> <span>$${((trip.driverIncomeUsd || 0) - (trip.personalExpenseDriver || 0)).toFixed(2)}</span></div>
            </div>

            <div class="total-box">
                <div class="row bold big"><span>SOF FOYDA:</span> <span>$${(trip.profitUsd || 0).toFixed(2)}</span></div>
            </div>

            <div class="footer">
                <p class="stamp">TASDIQLANDI</p>
                <p>ID: #TRP-${trip.id}</p>
                <p>Xizmatingiz uchun rahmat!</p>
            </div>
        </div>`;

            const style = document.createElement('style');
            style.innerHTML = `
            @media print {
                /* Sahifa o'lchamini auto qilib, ortiqcha joyni kesib tashlaymiz */
                @page {
                    size: 80mm auto;
                    margin: 0;
                }
                html, body {
                    height: auto;
                    overflow: hidden; /* Keyingi sahifalarni yaratishni cheklaydi */
                }
                body * { visibility: hidden; }
                #print-section, #print-section * { visibility: visible; }
                #print-section {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 72mm;
                    margin: 0;
                    padding: 2mm;
                    page-break-after: avoid;
                    page-break-inside: avoid;
                }
            }
            .ticket { font-family: 'Courier New', monospace; color: black; font-size: 11px; line-height: 1.2; }
            .header { text-align: center; margin-bottom: 5px; }
            .header h2 { margin: 0; font-size: 15px; border-bottom: 2px solid #000; }
            .line { border-top: 1px dashed #000; margin: 4px 0; }
            .row { display: flex; justify-content: space-between; margin: 2px 0; }
            .bold { font-weight: bold; border-top: 1px solid #000; padding-top: 2px; }
            .big { font-size: 14px; border-top: 2px solid #000; margin-top: 4px; }
            .red { color: #d00; }
            .driver-box { background: #f2f2f2; padding: 4px; margin: 4px 0; border: 1px solid #ddd; }
            .footer { text-align: center; margin-top: 10px; border-top: 1px solid #000; padding-top: 5px; }
            .stamp { font-weight: bold; border: 1px solid black; padding: 3px; display: inline-block; margin-bottom: 5px; }
        `;

            document.body.appendChild(style);
            document.body.appendChild(printContainer);

            window.print();

            document.body.removeChild(printContainer);
            document.body.removeChild(style);

        } catch (error) {
            console.error('Print error:', error);
        }
    }

    //trip expense
    // 1. Modalni ochish (Ochilganda ham tozalanadi)
    function addTruckExpense(tripId, truckId) {
        const form = document.getElementById('truckExpenseForm');
        form.reset();

        document.getElementById('teTripId').value = tripId;
        document.getElementById('teTruckId').value = truckId;
        document.getElementById('teDate').value = new Date().toISOString().split('T')[0];

        document.getElementById('truckExpenseModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeTruckExpenseModal() {
        const modal = document.getElementById('truckExpenseModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('truckExpenseForm').reset();
    }

    document.getElementById('truckExpenseForm').onsubmit = async function (e) {
        e.preventDefault();

        const amountUsd = parseFloat(document.getElementById('teAmountUsd').value);
        const tripId = document.getElementById('teTripId').value;

        if (!amountUsd || amountUsd <= 0) {
            alert("USD summa 0 dan katta bo'lishi shart!");
            return;
        }

        const payload = {
            truckId: parseInt(document.getElementById('teTruckId').value),
            tripId: parseInt(tripId),
            truckExpenseType: document.getElementById('teType').value,
            amountUsd: amountUsd,
            amountLocal: parseFloat(document.getElementById('teAmountLocal').value) || 0,
            localCurrency: document.getElementById('teLocalCurrency').value,
            description: document.getElementById('teDescription').value,
            expenseDate: document.getElementById('teDate').value
        };

        const response = await fetch(`${API_BASE}/truck-expense/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (data.success) {
            document.getElementById('truckExpenseForm').reset();
            showTripDetails(tripId);
            closeTruckExpenseModal();
            showNotify("Muvaffaqiyat", "Xarajat saqlandi", "success");
        } else {
            console.error('Error:', error);
            showNotify("Xato", data.message || "Xatolik!");
        }
    };

    async function updateTripStatus(tripId, currentStatus) {
        const nextStatus = (currentStatus === 'COMPLETED') ? 'IN_PROGRESS' : 'COMPLETED';
        const isFinishing = nextStatus === 'COMPLETED';

        const result = await Swal.fire({
            title: isFinishing ? "Xarajatlarni tasdiqlash" : "Tahrirlashni ochish",
            text: isFinishing
                ? "Barcha ma'lumotlar to'g'riligiga ishonchingiz komilmi? Reys yakunlanadi."
                : "Reysni qaytadan tahrirlash rejimiga o'tkazmoqchimisiz?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: isFinishing ? '‚úÖ Tasdiqlash' : 'üîì Ochish',
            cancelButtonText: 'Bekor qilish',
            background: 'rgba(255, 255, 255, 0.95)',
            backdrop: `rgba(0,0,0,0.2) blur(4px)`,
            customClass: {
                popup: 'apple-popup',
                confirmButton: `apple-button px-8 py-3 ${isFinishing ? 'bg-green-600' : 'bg-orange-500'} text-white rounded-lg mx-2 font-bold`,
                cancelButton: 'apple-button px-8 py-3 bg-gray-300 text-gray-700 rounded-lg mx-2 font-bold'
            },
            buttonsStyling: false
        });

        if (result.isConfirmed) {
            try {
                // 1. Joriy trip ma'lumotlarini olish
                const getRes = await fetch(`${API_BASE}/trip/${tripId}`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });
                const getData = await getRes.json();

                if (!getData.success) throw new Error("Ma'lumot topilmadi");

                const tripData = getData.object;

                // STATUSNI O'ZGARTIRISH
                tripData.tripStatus = nextStatus;

                // SANANI O'ZLASHTIRISH
                if (isFinishing) {
                    // Bugungi sanani ISO formatda (YYYY-MM-DD) berish
                    // Agar vaqt ham kerak bo'lsa: new Date().toISOString()
                    tripData.finishedDate = new Date().toISOString().split('T')[0];
                } else {
                    // Agar reys qaytadan ochilsa, tugash sanasini tozalash kerak bo'lishi mumkin
                    tripData.finishedDate = null;
                }

                // 2. Yangilangan ob'ektni PUT qilish
                const response = await fetch(`${API_BASE}/trip/${tripId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tripData)
                });

                const resData = await response.json();

                if (resData.success) {
                    // UI ni yangilash (Eski funksiyangiz)
                    if (typeof showTripDetails === "function") showTripDetails(tripId);

                    showNotify(
                        "Muvaffaqiyatli",
                        isFinishing ? "Xarajatlar tasdiqlandi va reys yakunlandi" : "Reys tahrirlash uchun ochildi",
                        "success"
                    );
                } else {
                    showNotify("Xatolik", resData.message || "Xatolik yuz berdi", "error");
                }
            } catch (error) {
                console.error("Update Error:", error);
                showNotify("Xatolik", "Server bilan bog'lanishda xatolik", "error");
            }
        }
    }

    async function deleteFuel(fuelId, tripId) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "O'chirilgan ma'lumotni qayta tiklab bo'lmaydi!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, o‚Äòchirilsin!',
            cancelButtonText: 'Bekor qilish'
        }).then(async (result) => {

            if (!result.isConfirmed) return;

            let response;

            // üîπ 1. Faqat FETCH uchun try/catch
            try {
                response = await fetch(`${API_BASE}/fuel/delete/${fuelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (networkError) {
                console.error("NETWORK ERROR:", networkError);
                showNotify("Tarmoq xatosi!", "Server bilan aloqa yo'q.", 'error');
                return;
            }

            // üîπ 2. HTTP status tekshirish
            if (!response.ok) {
                showNotify(
                    "Xatolik!",
                    `Server xatosi: ${response.status}`,
                    'error'
                );
                return;
            }

            // üîπ 3. JSON parsing (xavfsiz)
            let data = {success: true};

            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : {success: true};
            } catch (jsonError) {
                console.warn("JSON parse xatosi:", jsonError);
            }

            // üîπ 4. Business logic
            if (data.success) {
                showNotify(
                    "O'chirildi!",
                    data.message || "Yoqilg'i xarajati muvaffaqiyatli o'chirildi.",
                    'success'
                );

                // üîπ 5. UI yangilash (xavfsiz)
                try {
                    showTripDetails(tripId);
                } catch (uiError) {
                    console.error("loadTripDetails xatosi:", uiError);
                }

            } else {
                showNotify(
                    "Xatolik!",
                    data.message || "O'chirishda xatolik yuz berdi",
                    'error'
                );
            }
        });
    }

    // 1. MASHINA TA'MIRLASH XARAJATINI O'CHIRISH (truck-expense)
    async function deleteTruckExpense(expenseId, tripId) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "O'chirilgan ma'lumotni qayta tiklab bo'lmaydi!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, o‚Äòchirilsin!',
            cancelButtonText: 'Bekor qilish'
        }).then(async (result) => {
            if (!result.isConfirmed) return;

            let response;
            try {
                response = await fetch(`${API_BASE}/truck-expense/${expenseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (networkError) {
                console.error("NETWORK ERROR:", networkError);
                showNotify("Tarmoq xatosi!", "Server bilan aloqa yo'q.", 'error');
                return;
            }

            if (!response.ok) {
                showNotify("Xatolik!", `Server xatosi: ${response.status}`, 'error');
                return;
            }

            let data = {success: true};
            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : {success: true};
            } catch (jsonError) {
                console.warn("JSON parse xatosi:", jsonError);
            }

            if (data.success) {
                showNotify("O'chirildi!", "Mashina xarajati muvaffaqiyatli o'chirildi.", 'success');
                showTripDetails(tripId); // UI yangilash
            } else {
                showNotify("Xatolik!", data.message || "O'chirishda xatolik yuz berdi", 'error');
            }
        });
    }

    // 2. YO'L XARAJATINI O'CHIRISH (trip-expense)
    async function deleteTripExpense(expenseId, tripId) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "O'chirilgan ma'lumotni qayta tiklab bo'lmaydi!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, o‚Äòchirilsin!',
            cancelButtonText: 'Bekor qilish'
        }).then(async (result) => {
            if (!result.isConfirmed) return;

            let response;
            try {
                response = await fetch(`${API_BASE}/trip-expense/${expenseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (networkError) {
                console.error("NETWORK ERROR:", networkError);
                showNotify("Tarmoq xatosi!", "Server bilan aloqa yo'q.", 'error');
                return;
            }

            if (!response.ok) {
                showNotify("Xatolik!", `Server xatosi: ${response.status}`, 'error');
                return;
            }

            let data = {success: true};
            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : {success: true};
            } catch (jsonError) {
                console.warn("JSON parse xatosi:", jsonError);
            }

            if (data.success) {
                showNotify("O'chirildi!", "Yo'l xarajati muvaffaqiyatli o'chirildi.", 'success');
                showTripDetails(tripId); // UI yangilash
            } else {
                showNotify("Xatolik!", data.message || "O'chirishda xatolik yuz berdi", 'error');
            }
        });
    }

    function closeTripDetails() {
        document.getElementById('tripDetailsSection').classList.add('hidden');
        document.getElementById('tripsList').classList.remove('hidden');
    }

    // Clos modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
    // Check for existing token on page load
    window.addEventListener('load', () => {
        const savedToken = localStorage.getItem('authToken');
        if (savedToken) {
            authToken = savedToken;
            loadCurrentUser().then(() => {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showTab('dashboard');
            }).catch(() => {
                localStorage.removeItem('authToken');
            });
        }
    });
</script>
</body>
</html>
