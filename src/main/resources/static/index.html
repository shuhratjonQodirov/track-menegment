<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Boshqaruv Tizimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>

        @keyframes highlightRow {
            0% { background-color: #dbeafe; transform: scale(1.02); } /* Blue-100 va biroz kattalashish */
            100% { background-color: transparent; transform: scale(1); }
        }



        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-gray-100" >
<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-96">
        <h2 class="text-2xl font-bold mb-6 text-blue-600">Tizimga kirish</h2>
        <form id="loginForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Username (PNFL)</label>
                <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2">Password</label>
                <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                Kirish
            </button>
        </form>
        <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
    <!-- Header -->
    <div class="bg-white shadow-md">
        <div class="container mx-auto">
            <div class="flex items-center justify-between p-4 bg-white shadow-sm">
                <h1 class="text-2xl font-bold text-blue-600">Transport Boshqaruvi</h1>
                <div class="flex items-center gap-4 relative">

                    <button onclick="toggleProfileMenu()" class="flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition focus:outline-none border-2 border-blue-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </button>

                    <div id="profileDropdown" class="hidden absolute top-12 right-20 w-72 bg-white rounded-2xl shadow-2xl border border-gray-100 z-[100] p-5">
                        <div class="flex flex-col items-center border-b pb-4 mb-4">
                            <div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold mb-2">
                                <span id="userInitial">U</span>
                            </div>
                            <h3 id="profileName" class="text-lg font-bold text-gray-800 text-center leading-tight">...</h3>
                            <span id="profileRole" class="text-xs font-black text-blue-500 uppercase tracking-widest mt-1">...</span>
                        </div>

                        <div class="space-y-3 mb-4">
                            <div class="flex items-center gap-3">
                                <span class="p-2 bg-gray-50 rounded-lg text-gray-400">üìû</span>
                                <p id="profilePhone" class="text-sm font-semibold text-gray-600">...</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="p-2 bg-gray-50 rounded-lg text-gray-400">üìç</span>
                                <p id="profileAddress" class="text-sm font-semibold text-gray-600">...</p>
                            </div>
                        </div>

                        <button onclick="logout()" class="w-full py-2.5 bg-red-50 text-red-600 rounded-xl hover:bg-red-600 hover:text-white font-bold transition">
                            Chiqish
                        </button>
                    </div>

                </div>
            </div>

            <!-- Navigation -->
            <div class="flex border-t">
                <button onclick="showTab('dashboard')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100" data-tab="dashboard">
                    üìä Dashboard
                </button>
                <button onclick="showTab('users')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100" data-tab="users">
                    üë• Foydalanuvchilar
                </button>
                <button onclick="showTab('trucks')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100" data-tab="trucks">
                    üöõ Mashinalar
                </button>
                <button onclick="showTab('trips')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100" data-tab="trips">
                    üó∫Ô∏è Reyslar
                </button>
                <button onclick="showTab('settings')" class="tab-btn flex-1 px-6 py-4 font-semibold hover:bg-gray-100" data-tab="settings">
                    ‚öôÔ∏è Sozlamalar
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content container mx-auto p-6 bg-gray-50 min-h-screen">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Boshqaruv Paneli</h2>

        <div id="dashboardStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white transition hover:scale-105">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium opacity-80 uppercase tracking-wider">Jami Reyslar</p>
                        <p id="totalTrips" class="text-4xl font-bold mt-2">0</p>
                    </div>
                    <i class="fas fa-route text-2xl opacity-50"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="text-blue-600">üìä</span> Moliyaviy ko'rsatkichlar
                </h3>

                <div class="relative h-64 mb-8">
                    <canvas id="financeChart"></canvas>
                </div>

                <div class="grid grid-cols-3 gap-6 pt-6 border-t border-gray-50">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Yoqilg'i</p>
                        <p id="fuelExp" class="text-lg font-bold text-orange-600">$0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Texnik xizmat</p>
                        <p id="serviceExp" class="text-lg font-bold text-purple-600">$0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Oyliklar</p>
                        <p id="salaryExp" class="text-lg font-bold text-blue-600">$0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="text-purple-600">üèÜ</span> Top Haydovchilar
                </h3>
                <div id="topDriversList" class="space-y-6">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800">üìç Oxirgi reyslar</h3>
                <div id="recentTripsList" class="divide-y divide-gray-50">
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800">üöõ Mashinalar holati</h3>
                <div id="truckStatusList" class="space-y-4">
                </div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content container mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <!-- <<< YANGI ID >>> Header -->
            <div id="usersHeader" class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Foydalanuvchilar</h2>
                <div class="relative flex-1 max-w-md mx-4">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </span>
                    <input type="text"
                           id="userSearchInput"
                           onkeyup="searchUsers()"
                           placeholder="Foydalanuvchi ismi bilan qidiruv..."
                           class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>
                <button onclick="openAddUserModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    + Foydalanuvchi qo'shish
                </button>
            </div>

            <!-- <<< YANGI ID >>> User Type Tabs -->
            <div id="userTypeTabs" class="flex gap-2 mb-6">
                <button onclick="filterUsers('DRIVER')" class="user-filter-btn px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold" data-role="DRIVER">
                    Haydovchilar
                </button>
                <button onclick="filterUsers('MANAGER')" class="user-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold" data-role="MANAGER">
                    Menejerlar
                </button>
                <button onclick="filterUsers('ECONOMIST')" class="user-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold" data-role="ECONOMIST">
                    Iqtisodchilar
                </button>
            </div>

            <div id="usersList" class="space-y-3">
                <!-- Users will be loaded here -->
            </div>

        </div>
    </div>

    <!-- Trucks Tab -->
    <div id="trucks-tab" class="tab-content container mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <h2 class="text-2xl font-bold">Mashinalar</h2>

                <div class="relative flex-1 max-w-md mx-4">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </span>
                    <input type="text"
                           id="truckSearchInput"
                           onkeyup="searchTrucks()"
                           placeholder="Mashina raqami bo'yicha qidiruv..."
                           class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>

                <button onclick="openAddTruckModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition shadow-md">
                    + Mashina qo'shish
                </button>
            </div>

            <div id="trucksList" class="space-y-3">
                <!-- Trucks will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Trips Tab -->
    <div id="trips-tab" class="tab-content container mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Reyslar</h2>

                <div class="relative flex-1 max-w-md mx-4">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </span>
                    <input type="text"
                           id="tripSearchInput"
                           onkeyup="searchTrucks()"
                           placeholder="Sayoxat id bilan qidiruv..."
                           class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>
                <button onclick="openAddTripModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    + Reys qo'shish
                </button>
            </div>

            <div id="tripsList" class="space-y-3">
                <!-- Trips will be loaded here -->
            </div>
            <!-- üîΩ TANLANGAN REYS TAFSILOTLARI -->
            <div id="tripDetailsSection" class="hidden mt-8">
                <!-- Details shu yerda ochiladi -->
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content container mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6">Sozlamalar</h2>
            <div class="space-y-4">
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold mb-2">Foydalanuvchi ma'lumotlari</h3>
                    <div id="userDetails"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- User Details Section -->
    <div id="userDetailsSection" class="hidden">
        <!-- Batafsil ma'lumotlar shu yerda -->
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6">Yangi foydalanuvchi qo'shish</h3>
        <form id="addUserForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Lavozim *</label>
                <select name="userType" class="w-full px-4 py-2 border rounded-lg" required>
                    <option value="">Tanlang</option>
                    <option value="DRIVER">Haydovchi</option>
                    <option value="MANAGER">Meneger</option>
                    <option value="ECONOMIST">Iqtisodchi</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">F.I.O *</label>
                    <input type="text" name="fullName" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Telefon *</label>
                    <input type="text" name="phoneNumber" class="w-full px-4 py-2 border rounded-lg" placeholder="+998901234567" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Passport *</label>
                    <input type="text" name="passportNumber" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">PNFL *</label>
                    <input type="text" name="pnfl" class="w-full px-4 py-2 border rounded-lg" maxlength="14" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Parol *</label>
                    <input type="password" name="password" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Manzil *</label>
                    <input type="text" name="address" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Tug'ilgan sana *</label>
                    <input type="date" name="brithDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Ishga kirgan sana *</label>
                    <input type="date" name="hireDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    ‚úì Saqlash
                </button>
                <button type="button" onclick="closeAddUserModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                    Bekor qilish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Truck Modal -->
<div id="addTruckModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6">Yangi mashina qo'shish</h3>
        <form id="addTruckForm">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Davlat raqami *</label>
                    <input type="text" name="truckNumber" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Model *</label>
                    <input type="text" name="modelName" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Yili *</label>
                    <input type="number" name="manufactureYear" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Narxi ($) *</label>
                    <input type="number" step="0.01" name="buyPrice" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Sotib olingan sana *</label>
                    <input type="date" name="buyDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Holati *</label>
                    <select name="truckStatus" class="w-full px-4 py-2 border rounded-lg" required>
                        <option value="ACTIVE">ACTIVE</option>
                        <option value="REPAIR">REPAIR</option>
                        <option value="INACTIVE">INACTIVE</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    ‚úì Saqlash
                </button>
                <button type="button" onclick="closeAddTruckModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                    Bekor qilish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Trip Modal -->
<div id="addTripModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6">Yangi reys qo'shish</h3>
        <form id="addTripForm">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Mashina *</label>
                    <select name="truckId" id="tripTruckSelect" class="w-full px-4 py-2 border rounded-lg" required>
                        <option value="">Tanlang</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Haydovchi *</label>
                    <select name="userId" id="tripDriverSelect" class="w-full px-4 py-2 border rounded-lg" required>
                        <option value="">Tanlang</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Qayerdan *</label>
                    <input type="text" name="routeFrom" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Qayerga *</label>
                    <input type="text" name="routeTo" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Chiqish narxi ($) *</label>
                    <input type="number" step="0.01" name="incomeOutUsd" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Qaytish narxi ($) *</label>
                    <input type="number" step="0.01" name="incomeBackUsd" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Haydovchi oyligi ($) *</label>
                    <input type="number" step="0.01" name="driverIncomeUsd" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Boshlangan sana *</label>
                    <input type="date" name="startedDate" class="w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Davomiyligi (kun)</label>
                    <input type="number" name="tripDuration" class="w-full px-4 py-2 border rounded-lg" value="0">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    ‚úì Saqlash
                </button>
                <button type="button" onclick="closeAddTripModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                    Bekor qilish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Trip Details Modal -->
<div id="tripDetailsModal" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold">Reys ma'lumotlari</h3>
            <button onclick="closeTripDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="tripDetailsContent">
            <!-- Details will be loaded here -->
        </div>
    </div>
</div>

<!-- Fuel Modal -->
<div id="fuelModal" class="fixed inset-0 z-[150] hidden overflow-y-auto backdrop-blur-sm bg-black/40 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white w-full max-w-lg shadow-[0_20px_40px_rgba(0,0,0,0.12)] rounded-[24px] border border-gray-100 p-6 transform transition-all">

            <div class="flex justify-between items-center mb-5">
                <div>
                    <h3 class="text-xl font-bold text-gray-900 tracking-tight">Yonilg‚Äòi sarfi</h3>
                    <p class="text-[12px] text-gray-400">Xarajatni kiriting</p>
                </div>
                <button onclick="closeFuelModal()" class="p-1.5 bg-gray-50 hover:bg-gray-100 rounded-full transition-colors group">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="fuelForm" class="space-y-4">
                <input type="hidden" id="fuelTripId">
                <input type="hidden" id="fuelTruckId">

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Litr</label>
                        <input type="number" step="0.01" id="fuelLitres" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="0.00" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Narxi (1L uchun)</label>
                        <input type="number" step="0.01" id="fuelPricePerLitres" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="0.00" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Valyuta</label>
                        <select id="fuelLocalCurrency" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer font-semibold text-gray-700">
                            <option value="UZS">UZS</option>
                            <option value="USD">USD</option>
                            <option value="RUB">RUB</option>
                            <option value="KZT">KZT</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Mahalliy summa</label>
                        <input type="number" step="0.01" id="fuelAmountLocal" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="0.00" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-bold text-blue-600 ml-1">Jami USD</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400 font-bold text-xs">$</span>
                            <input type="number" step="0.01" id="fuelTotalAmountUsd" class="w-full bg-blue-50/50 border-none ring-1 ring-blue-100 rounded-xl p-3 pl-7 text-sm focus:ring-2 focus:ring-blue-600 outline-none font-bold text-blue-700" placeholder="0.00" required>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Sana</label>
                        <input type="date" id="fuelDate" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Shoxobcha</label>
                        <input type="text" id="fuelGasStationName" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nomini kiriting" required>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[12px] font-semibold text-gray-500 ml-1">Davlat</label>
                        <input type="text" id="fuelCountry" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masalan: O'zbekiston" required>
                    </div>
                </div>

                <div class="flex gap-3 pt-3">
                    <button type="button" onclick="closeFuelModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-200 transition-all active:scale-95">
                        Bekor qilish
                    </button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-100 transition-all active:scale-95">
                        Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Trip Expense Modal -->
<div id="expenseModal" class="fixed inset-0 z-[150] hidden overflow-y-auto backdrop-blur-sm bg-black/40 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white w-full max-w-md shadow-2xl rounded-[32px] border border-gray-100 p-8">

            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900 tracking-tight">Xarajat qo'shish</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <form id="expenseForm" class="space-y-6">
                <input type="hidden" id="tripIdField">

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Xarajat turi</label>
                    <select id="type" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer" required>
                        <option value="ROAD_TAX">üõ£Ô∏è Yo ªl solig ªi</option>
                        <option value="PARKING">üÖøÔ∏è To ªxtash joyi</option>
                        <option value="BROKER_FEE">ü§ù Posrednik to ªlovi</option>
                        <option value="CUSTOMS_DUTY">üõÉ Bojxona to ªlovi</option>
                        <option value="FINE">‚ö†Ô∏è Jarima</option>
                        <option value="WEIGHING">‚öñÔ∏è Vesovoy</option>
                        <option value="ESCORT">üöî Soprovog ªdeniye</option>
                        <option value="LOADING_UNLOADING">üì¶ Yuk ortish/tushirish</option>
                        <option value="TOLL_ROAD">üé´ Pullik yo ªl</option>
                        <option value="OTHER">üìÅ Boshqa</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Mahalliy summa</label>
                        <input type="number" id="amountLocal" step="0.01" placeholder="0.00" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Valyuta</label>
                        <select id="localCurrency" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer font-bold text-gray-700">
                            <option value="UZS">UZS</option>
                            <option value="USD">USD</option>
                            <option value="RUB">RUB</option>
                            <option value="KZT">KZT</option>
                            <option value="EUR">EUR</option>
                            <option value="TRY">TRY</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">USD ekvivalenti</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                            <input type="number" id="amountUsd" step="0.01" placeholder="0.00" class="w-full bg-blue-50/50 border-none ring-1 ring-blue-100 rounded-2xl p-3.5 pl-7 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all font-bold text-blue-600" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Sana</label>
                        <input type="date" id="expenseDate" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer" required>
                    </div>
                </div>

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Tavsif (ixtiyoriy)</label>
                    <textarea id="description" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none" rows="2" placeholder="Xarajat haqida izoh..."></textarea>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold hover:bg-gray-200 transition-all active:scale-95">
                        Bekor qilish
                    </button>
                    <button type="submit" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-xl shadow-blue-100 transition-all active:scale-95">
                        Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="truckExpenseModal" class="fixed inset-0 z-[150] hidden overflow-y-auto backdrop-blur-sm bg-black/40 transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white w-full max-w-md shadow-2xl rounded-[32px] border border-gray-100 p-8">

            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900 tracking-tight">üîß Mashina xarajati</h3>
                <button type="button" onclick="closeTruckExpenseModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="truckExpenseForm" class="space-y-6">
                <input type="hidden" id="teTripId">
                <input type="hidden" id="teTruckId">

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Xarajat turi</label>
                    <select id="teType" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer" required>
                        <option value="TIRE">üßø Balon (Tire)</option>
                        <option value="OIL_CHANGE">üõ¢Ô∏è Moy almashtirish</option>
                        <option value="FILTER">üå™Ô∏è Filtr</option>
                        <option value="BRAKE_REPAIR">üõë Tormoz ta'miri</option>
                        <option value="ENGINE_REPAIR">‚öôÔ∏è Dvigatel ta'miri</option>
                        <option value="WASH">üßº Yuvish</option>
                        <option value="TECH_INSPECTION">üìù Texosmot</option>
                        <option value="INSURANCE">üõ°Ô∏è Sug'urta</option>
                        <option value="OTHER">üìÅ Boshqa</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Mahalliy summa</label>
                        <input type="number" id="teAmountLocal" step="0.01" placeholder="0.00" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Valyuta</label>
                        <select id="teLocalCurrency" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer font-bold text-gray-700">
                            <option value="UZS">UZS</option>
                            <option value="USD">USD</option>
                            <option value="RUB">RUB</option>
                            <option value="KZT">KZT</option>
                            <option value="TRY">TRY</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">USD ekvivalenti</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                            <input type="number" id="teAmountUsd" step="0.01" placeholder="0.00" class="w-full bg-blue-50/50 border-none ring-1 ring-blue-100 rounded-2xl p-3.5 pl-7 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all font-bold text-blue-600" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Sana</label>
                        <input type="date" id="teDate" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer" required>
                    </div>
                </div>

                <div>
                    <label class="block text-[13px] font-semibold text-gray-500 ml-1 mb-1.5">Tavsif (ixtiyoriy)</label>
                    <textarea id="teDescription" class="w-full bg-gray-50 border-none ring-1 ring-gray-200 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none" rows="2" placeholder="Xarajat haqida izoh..."></textarea>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeTruckExpenseModal()" class="flex-1 py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold hover:bg-gray-200 transition-all active:scale-95">
                        Bekor qilish
                    </button>
                    <button type="submit" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-xl shadow-blue-100 transition-all active:scale-95">
                        Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script  >
    const API_BASE = 'https://track-menegment-2.onrender.com/api/v1';
    let authToken = null;
    let currentUser = null;
    let currentUserFilter = 'DRIVER';
    let currentEditingUserRole = null;
    let currentEditingUserId = null;
    let allUsers = { drivers: [], managers: [], economists: [] };
    let myChart = null; // Global o'zgaruvchi

    const showNotify = (title, text, icon = 'success') => {
        Swal.fire({
            title: title,
            text: text,
            icon: icon,
            timer: 2100,
            showConfirmButton: icon === 'error',
            position: 'center',
            // Apple Style sozlamalari
            background: 'rgba(255, 255, 255, 0.95)',
            backdrop: `rgba(0,0,0,0.1) blur(4px)`, // Orqa fonni xiralashtirish
            customClass: {
                popup: 'apple-popup',
                title: 'apple-title',
                htmlContainer: 'apple-text',
                confirmButton: 'apple-button',
                icon: 'apple-icon'
            },
            buttonsStyling: false, // Default dizaynni o'chiramiz
            showClass: {
                popup: 'animate__animated animate__fadeIn animate__faster' // Mayin ochilish
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOut animate__faster'
            }
        });
    };

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok && data.token) {
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                await loadCurrentUser();
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showTab('dashboard');
            } else {
                document.getElementById('loginError').textContent = 'Login yoki parol xato!';
                document.getElementById('loginError').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Login error:', error);
            document.getElementById('loginError').textContent = 'Serverga ulanishda xatolik!';
            document.getElementById('loginError').classList.remove('hidden');
        }
    });
    // Fuel form submit
    document.getElementById('fuelForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Ma'lumotlarni yig'ish
        const tripId = parseInt(document.getElementById('fuelTripId').value);
        const truckId = parseInt(document.getElementById('fuelTruckId').value);
        const litres = parseFloat(document.getElementById('fuelLitres').value);
        const pricePerLitres = parseFloat(document.getElementById('fuelPricePerLitres').value);
        const localCurrency = document.getElementById('fuelLocalCurrency').value;
        const amountLocal = parseFloat(document.getElementById('fuelAmountLocal').value);
        const totalAmountUsd = parseFloat(document.getElementById('fuelTotalAmountUsd').value); // Qo'lda kiritilgan USD
        const gasStationName = document.getElementById('fuelGasStationName').value;
        const country = document.getElementById('fuelCountry').value;
        const fuelDate = document.getElementById('fuelDate').value;

        const payload = {
            tripId,
            truckId,
            litres,
            PricePerLitres: pricePerLitres, // Backend DTO ga mos ravishda
            localCurrency,
            amountLocal,
            totalAmountUsd,
            gasStationName,
            country,
            fuelDate
        };

        try {
            const response = await fetch(`${API_BASE}/fuel/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok || data.success) {
                showNotify("Muvaffaqiyatli!","Yonilg‚Äòi muvaffaqiyatli qo‚Äòshildi!");
                closeFuelModal();
                if (typeof showTripDetails === "function") {
                    showTripDetails(tripId);
                }
            } else {
                showNotify("Xatolik!", data.message || "Xatolik yuz berdi", "error");            }
        } catch (error) {
            console.error("POST Fuel xatolik:", error);
            showNotify("Muommo mavjud !","Server bilan bog'lanishda xatolik yuz berdi!");
        }
    });

    document.getElementById('addTruckForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.buyPrice = parseFloat(data.buyPrice);
        data.manufactureYear = parseInt(data.manufactureYear);

        try {
            const response = await fetch(`${API_BASE}/truck/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showNotify("Muvaffaqiyatli !",'Mashina muvaffaqiyatli qo\'shildi!');
                closeAddTruckModal();
                loadTrucks();
            } else {
                showNotify("Kutilmagan xatolik",'Xatolik yuz berdi!');
            }
        } catch (error) {
            console.error('Error creating truck:', error);
            showNotify("Kutilmagan xatolik",'Xatolik yuz berdi!');
        }
    });

    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        let data = Object.fromEntries(formData.entries());

        let url = '';
        let method = 'POST';

        if (currentEditingUserId) {
            // === Tahrirlash (UPDATE) ===
            method = 'PUT';
            url = `${API_BASE}/user/update/${currentEditingUserId}`;

            // Parol bo‚Äòsh bo‚Äòlsa yubormaymiz
            if (!data.password) {
                delete data.password;
            }
            // userType update da kerak emas
            delete data.userType;
        } else {
            // === Yangi qo‚Äòshish (CREATE) ===
            const userType = data.userType;
            if (!userType) {
                showNotify("Muommo mavjud!",'Lavozim tanlang!');
                return;
            }
            delete data.userType;

            switch (userType) {
                case 'DRIVER':
                    url = `${API_BASE}/user/create-driver`;
                    break;
                case 'MANAGER':
                    url = `${API_BASE}/user/create-manager`;
                    break;
                case 'ECONOMIST':
                    url = `${API_BASE}/user/create-economist`;
                    break;
                default:
                    showNotify("Muommo mavjud!",'Noto‚Äòg‚Äòri lavozim!');
                    return;
            }
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && (result.success || result.object)) {
                showNotify("Muvaffaqiyatli!",currentEditingUserId
                    ? 'Foydalanuvchi  yangilandi!'
                    : 'Foydalanuvchi  qo‚Äòshildi!');
                closeAddUserModal();
                loadAllUsers(); // ro‚Äòyxatni yangilaydi
            } else {
                showNotify("Muommo ",'Xatolik: ' + (result.message || 'Noma ºlum xatolik'));
            }
        } catch (error) {
            console.error('Submit error:', error);
            showNotify("Muommo mavjud !",'Serverga ulanishda xatolik!');
        }
    });

    document.getElementById('addTripForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        data.truckId = parseInt(data.truckId);
        data.driverId = parseInt(data.userId);
        data.incomeOutUsd = parseFloat(data.incomeOutUsd);
        data.incomeBackUsd = parseFloat(data.incomeBackUsd);
        data.driverIncomeUsd = parseFloat(data.driverIncomeUsd);
        data.tripDuration = parseInt(data.tripDuration) || 0;
        data.driverIncomePaid = false;
        data.tripStatus = 'IN_PROGRESS';
        data.finishedDate = '';

        try {
            const response = await fetch(`${API_BASE}/trip/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showNotify("Muvaffaqiyatli !",'Reys  qo\'shildi!');
                closeAddTripModal();
                loadTrips();
            } else {
                showNotify("Kutilmagan xatolik",'Xatolik yuz berdi!');
            }
        } catch (error) {
            console.error('Error creating trip:', error);
            showNotify("Kutilmagan xatolik",'Xatolik yuz berdi!');
        }
    });


    async function loadCurrentUser() {
        try {
            const response = await fetch(`${API_BASE}/user/me`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await response.json();

            if (data.success) {
                currentUser = data.object;

                // Profil ma'lumotlarini to'ldirish
                document.getElementById('profileName').textContent = currentUser.fullName;
                document.getElementById('profileRole').textContent = currentUser.role;
                document.getElementById('profilePhone').textContent = currentUser.phoneNumber;
                document.getElementById('profileAddress').textContent = currentUser.address;

                // Ismning birinchi harfini ikonka uchun olish
                document.getElementById('userInitial').textContent = currentUser.fullName.charAt(0).toUpperCase();

                // Sozlamalar bo'limidagi ma'lumotlarni ham yangilash (agar kerak bo'lsa)
                const settingsDetails = document.getElementById('userDetails');
                if(settingsDetails) {
                    settingsDetails.innerHTML = `
                    <p><strong>Ism:</strong> ${currentUser.fullName}</p>
                    <p><strong>Lavozim:</strong> ${currentUser.role}</p>
                    <p><strong>Telefon:</strong> ${currentUser.phoneNumber}</p>
                    <p><strong>Manzil:</strong> ${currentUser.address}</p>
                `;
                }
            }
        } catch (error) {
            console.error('Error loading user:', error);
        }
    }
    function toggleProfileMenu() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('hidden');

        // Tashqariga bosganda yopilish mantig'i
        const closeMenu = (e) => {
            if (!e.target.closest('.relative')) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        };

        if (!dropdown.classList.contains('hidden')) {
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }
    }

    function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem('authToken');
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }

    function showTab(tabName) {
        // 1. Barcha tablarni yashirish (Hozir dashboard-tab ham yashiriladi)
        const tabs = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.classList.add('hidden');
        });

        // 2. Navigatsiya tugmalaridan aktiv rangni olib tashlash
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'bg-gray-100');
        });

        // 3. Tanlangan tabni ko'rsatish
        const selectedTab = document.getElementById(`${tabName}-tab`);
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
        }

        // 4. Tanlangan tugmani aktiv qilish
        const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeBtn) {
            activeBtn.classList.add('bg-blue-600', 'text-white');
        }

        // 5. Ma'lumotlarni yuklash (Faqat kerakli bo'lim yuklanadi)
        if (tabName === 'dashboard') loadDashboard();
        else if (tabName === 'users') loadAllUsers();
        else if (tabName === 'trucks') loadTrucks();
        else if (tabName === 'trips') loadTrips();
    }

    async function loadDashboard() {
        try {
            const [tripsRes, trucksRes, driversRes, managersRes, economistsRes] = await Promise.all([
                fetch(`${API_BASE}/trip/getAll`, { headers: { 'Authorization': `Bearer ${authToken}` }}),
                fetch(`${API_BASE}/truck/list-truck`, { headers: { 'Authorization': `Bearer ${authToken}` }}),
                fetch(`${API_BASE}/user/list-driver`, { headers: { 'Authorization': `Bearer ${authToken}` }}),
                fetch(`${API_BASE}/user/list-manager`, { headers: { 'Authorization': `Bearer ${authToken}` }}),
                fetch(`${API_BASE}/user/list-economist`, { headers: { 'Authorization': `Bearer ${authToken}` }})
            ]);

            const trips = await tripsRes.json();
            const trucks = await trucksRes.json();
            const drivers = await driversRes.json();
            const managers = await managersRes.json();
            const economists = await economistsRes.json();

            if (trips.success) {
                document.getElementById('totalTrips').textContent = trips.object.length;
                document.getElementById('inProgressTrips').textContent =
                    trips.object.filter(t => t.tripStatus === 'IN_PROGRESS').length;
            }
            if (trucks.success) {
                document.getElementById('activeTrucks').textContent =
                    trucks.object.filter(t => t.truckStatus === 'ACTIVE').length;
            }

            let totalUsers = 0;
            if (drivers.success) totalUsers += drivers.object.length;
            if (managers.success) totalUsers += managers.object.length;
            if (economists.success) totalUsers += economists.object.length;
            document.getElementById('totalUsers').textContent = totalUsers;
            const ctx = document.getElementById('financeChart').getContext('2d');
            myChart =new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jami daromad', 'Xarajatlar', 'Sof foyda'],
                    datasets: [{
                        label: 'Summa ($)',
                        data: [18300, 6886, 7189], // Bu yerga API dan kelgan summalarni qo'ying
                        backgroundColor: ['#22c55e', '#ef4444', '#3b82f6'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false // Konteynerga moslashishi uchun
                }
            });

            // 2. Top Haydovchilar (Simulyatsiya)
            const driversList = document.getElementById('topDriversList');
            drivers.object.slice(0, 3).forEach((driver, index) => {
                driversList.innerHTML += `
            <div class="flex justify-between items-center p-2 border-b">
                <span>${index + 1}. ${driver.fullName}</span>
                <span class="font-bold text-green-600">$7189</span>
            </div>`;
            });
            const truckList = document.getElementById('truckStatusList');
            document.getElementById('topDriversList').innerHTML = ''; // Tozalash shart!
            document.getElementById('truckStatusList').innerHTML = ''; // Tozalash shart!
            trucks.object.slice(0, 4).forEach(truck => {
                const statusColor = truck.truckStatus === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700';
                truckList.innerHTML += `
            <div class="flex justify-between p-2 border rounded-lg">
                <div><p class="font-bold">${truck.truckNumber}</p><p class="text-xs text-gray-500">${truck.model}</p></div>
                <span class="px-2 py-1 rounded text-xs h-fit ${statusColor}">${truck.truckStatus}</span>
            </div>`;
            });
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    async function loadAllUsers() {
        try {
            const [driversRes, managersRes, economistsRes] = await Promise.all([
                fetch(`${API_BASE}/user/list-driver`, { headers: { 'Authorization': `Bearer ${authToken}` }}),
                fetch(`${API_BASE}/user/list-manager`, { headers: { 'Authorization': `Bearer ${authToken}` }}),
                fetch(`${API_BASE}/user/list-economist`, { headers: { 'Authorization': `Bearer ${authToken}` }})
            ]);

            const drivers = await driversRes.json();
            const managers = await managersRes.json();
            const economists = await economistsRes.json();

            if (drivers.success) allUsers.drivers = drivers.object;
            if (managers.success) allUsers.managers = managers.object;
            if (economists.success) allUsers.economists = economists.object;

            filterUsers(currentUserFilter);
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function filterUsers(role) {
        currentUserFilter = role;

        document.querySelectorAll('.user-filter-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        document.querySelector(`[data-role="${role}"]`).classList.remove('bg-gray-200', 'text-gray-700');
        document.querySelector(`[data-role="${role}"]`).classList.add('bg-blue-600', 'text-white');

        let users = [];
        if (role === 'DRIVER') users = allUsers.drivers;
        if (role === 'MANAGER') users = allUsers.managers;
        if (role === 'ECONOMIST') users = allUsers.economists;

        const usersList = document.getElementById('usersList');
        usersList.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
        usersList.innerHTML = users.map(user => `
    <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="space-y-2">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">F.I.O</p>
                    <p class="font-bold text-lg text-gray-800 leading-tight">${user.fullName}</p>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Manzil va Yosh</p>
                    <p class="text-sm text-gray-600 font-medium">${user.address} | ${user.age} yosh</p>
                </div>
                <div class="flex gap-4">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Telefon</p>
                        <p class="text-sm text-gray-700 font-semibold">${user.phoneNumber}</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">PNFL</p>
                        <p class="text-sm text-gray-700 font-semibold tracking-tighter">${user.pnfl}</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-4">
                <span class="px-3 py-1 bg-blue-50 text-blue-600 border border-blue-100 rounded-md text-[10px] font-black uppercase tracking-widest">
                    ${user.role}
                </span>

                <div class="flex gap-2">
                    <button onclick="viewUser('${user.id}')"
                            class="p-2 text-blue-600 hover:bg-blue-600 hover:text-white rounded-lg transition-colors border border-blue-100 shadow-sm"
                            title="Batafsil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>

                    <button onclick="editUser('${user.id}')"
                            class="p-2 text-amber-600 hover:bg-amber-600 hover:text-white rounded-lg transition-colors border border-amber-100 shadow-sm"
                            title="Tahrirlash">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
`).join('');
    }
    // User Modal Functions
    function openAddUserModal() {
        // Modalni ochamiz
        document.getElementById('addUserModal').classList.add('active');

        // Formani tozalaymiz (barcha inputlar bo'sh bo'ladi)
        document.getElementById('addUserForm').reset();

        // Sarlavhani "Yangi qo'shish" holatiga qaytaramiz
        document.querySelector('#addUserModal h3').innerText = "Yangi foydalanuvchi qo'shish";

        // Lavozim tanlovini ochamiz va bo'sh qilamiz
        const userTypeSelect = document.querySelector('#addUserForm [name="userType"]');
        userTypeSelect.disabled = false;   // yangi qo‚Äòshishda tanlash ochiq bo‚Äòladi
        userTypeSelect.value = "";         // hech qanday tanlov bo‚Äòlmasin

        // Edit rejimi tozalanadi (agar oldin qolgan bo‚Äòlsa)
        currentEditingUserId = null;
        currentEditingUserRole = null;
    }

    async function editUser(userId) {
        // allUsers ob'ektidan foydalanuvchini topamiz (drivers, managers, economists)
        let user = null;
        let role = null;

        const roleMap = {
            drivers: 'DRIVER',
            managers: 'MANAGER',
            economists: 'ECONOMIST'
        };

        for (const key in roleMap) {
            user = allUsers[key].find(u => u.id == userId); // == ishlatdim, chunki id string bo‚Äòlishi mumkin
            if (user) {
                role = roleMap[key];
                break;
            }
        }

        if (!user) {
            showNotify("Muommo",'Foydalanuvchi topilmadi!');
            return;
        }

        // O‚Äòzgaruvchilarga saqlaymiz
        currentEditingUserId = userId;
        currentEditingUserRole = role;

        // Modalni ochamiz
        document.getElementById('addUserModal').classList.add('active');

        // Sarlavhani o‚Äòzgartiramiz
        document.querySelector('#addUserModal h3').innerText = 'Foydalanuvchi ma ºlumotlarini tahrirlash';

        // Lavozimni tanlaymiz va disable qilamiz (o‚Äòzgartirish taqiqlanadi)
        const userTypeSelect = document.querySelector('#addUserForm [name="userType"]');
        userTypeSelect.value = role;
        userTypeSelect.disabled = true;

        // Formani to‚Äòldiramiz (mavjud fieldlar bo‚Äòyicha)
        document.querySelector('#addUserForm [name="fullName"]').value = user.fullName || '';
        document.querySelector('#addUserForm [name="phoneNumber"]').value = user.phoneNumber || '';
        document.querySelector('#addUserForm [name="passportNumber"]').value = user.passportNumber || '';
        document.querySelector('#addUserForm [name="pnfl"]').value = user.pnfl || '';
        document.querySelector('#addUserForm [name="address"]').value = user.address || '';
        document.querySelector('#addUserForm [name="password"]').value = ''; // parol bo‚Äòsh qoldiriladi

        // Tug‚Äòilgan sana va ishga kirgan sana listda yo‚Äòq ‚Üí bo‚Äòsh qoldiramiz
        // Agar backendda bu fieldlar majburiy bo‚Äòlmasa, muammo bo‚Äòlmaydi
        document.querySelector('#addUserForm [name="brithDate"]').value =user.brithDate ||'';
        document.querySelector('#addUserForm [name="hireDate"]').value =user.hireDate ||'';

    }

    function closeAddUserModal() {
        // Modalni yopamiz
        document.getElementById('addUserModal').classList.remove('active');

        // Formani tozalaymiz (barcha input, select, textarea bo'sh bo'ladi)
        document.getElementById('addUserForm').reset();

        // Sarlavhani asl holatga qaytaramiz
        document.querySelector('#addUserModal h3').innerText = "Yangi foydalanuvchi qo'shish";

        // Lavozim tanlovini ochamiz va bo'sh qilamiz
        const userTypeSelect = document.querySelector('#addUserForm [name="userType"]');
        userTypeSelect.disabled = false;   // tanlash ochiladi
        userTypeSelect.value = "";         // tanlov tozalanadi

        // Edit rejimi o'chiriladi
        currentEditingUserId = null;
        currentEditingUserRole = null;
    }

    // Truck Modal Functions
    function openAddTruckModal() {
        document.getElementById('addTruckModal').classList.add('active');
    }

    function closeAddTruckModal() {
        document.getElementById('addTruckModal').classList.remove('active');
        document.getElementById('addTruckForm').reset();
    }

    async function loadTrucks() {
        try {
            const response = await fetch(`${API_BASE}/truck/list-truck`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await response.json();

            if (data.success) {
                const trucksList = document.getElementById('trucksList');
                trucksList.className = "grid grid-cols-2 gap-4"; // 2 ustunli va orasi ochiq
                trucksList.innerHTML = data.object.map(truck => `
    <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="space-y-2">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Davlat raqami</p>
                    <p class="font-bold text-xl text-blue-600">${truck.truckNumber}</p>
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Model va Yili</p>
                    <p class="text-gray-700 font-semibold">${truck.modelName} <span class="text-gray-400">(${truck.manufactureYear})</span></p>
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Sotib olingan narxi</p>
                    <p class="text-sm font-bold text-gray-800">$${truck.buyPrice.toLocaleString()}</p>
                </div>
            </div>

            <div class="flex flex-col items-end gap-4">
                <div class="flex gap-2">
                    <button onclick="viewTruck('${truck.id}')"
                            class="p-2 text-blue-600 hover:bg-blue-600 hover:text-white rounded-lg transition-colors border border-blue-100 shadow-sm"
                            title="Batafsil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>

                    <button onclick="editTruck('${truck.id}')"
                            class="p-2 text-amber-600 hover:bg-amber-600 hover:text-white rounded-lg transition-colors border border-amber-100 shadow-sm"
                            title="Tahrirlash">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>

                <span class="px-3 py-1 rounded-md text-[10px] font-black uppercase tracking-widest border ${
                    truck.truckStatus === 'ACTIVE' ? 'bg-green-50 text-green-600 border-green-200' :
                        truck.truckStatus === 'REPAIR' ? 'bg-amber-50 text-amber-600 border-amber-200' :
                            'bg-red-50 text-red-600 border-red-200'
                }">
                    ${truck.truckStatus}
                </span>
            </div>
        </div>
    </div>
`).join('');
            }
        } catch (error) {
            console.error('Error loading trucks:', error);
        }
    }

    function addFuel(tripId, truckId) {
        document.getElementById('fuelForm').reset();

        document.getElementById('fuelTripId').value = tripId;
        document.getElementById('fuelTruckId').value = truckId;

        document.getElementById('fuelModal').classList.remove('hidden');
    }
    // Formani yuborish
    document.getElementById('expenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Tugmani bloklash (Double click oldini olish)
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerText;
        submitBtn.disabled = true;
        submitBtn.innerText = "Saqlanmoqda...";

        // Ma'lumotlarni yig'ish (Sizning fuelForm uslubingizda)
        const tripId = parseInt(document.getElementById('tripIdField').value);
        const type = document.getElementById('type').value;
        const amountLocal = parseFloat(document.getElementById('amountLocal').value);
        const localCurrency = document.getElementById('localCurrency').value;
        const amountUsd = parseFloat(document.getElementById('amountUsd').value);
        const description = document.getElementById('description').value;
        const expenseDate = document.getElementById('expenseDate').value;

        const payload = {
            tripId,
            type,
            amountLocal,
            localCurrency,
            amountUsd,
            description,
            expenseDate
        };

        try {
            const response = await fetch(`${API_BASE}/trip-expense/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}` // Tokenni ham qo'shdik
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok || data.success) {
                showNotify("Muvaffaqiyatli!", "Xarajat muvaffaqiyatli qo‚Äòshildi!");

                // Formani tozalash va modalni yopish
                closeModal();

                // Agar asosiy oynadagi ma'lumotlarni yangilash funksiyasi bo'lsa
                if (typeof showTripDetails === "function") {
                    showTripDetails(tripId);
                }
            } else {
                showNotify("Xatolik!", data.message || "Xatolik yuz berdi", "error");
            }
        } catch (error) {
            console.error("POST TripExpense xatolik:", error);
            showNotify("Muammo mavjud!", "Server bilan bog'lanishda xatolik yuz berdi!", "error");
        } finally {
            // Har qanday holatda ham tugmani qayta aktivlashtirish
            submitBtn.disabled = false;
            submitBtn.innerText = originalBtnText;
        }
    });

    // Modalni yopish
    function closeFuelModal() {
        document.getElementById('fuelForm').reset();
        document.getElementById('fuelModal').classList.add('hidden');
    }

    function addTripExpense(tripId) {
        const modal = document.getElementById('expenseModal');
        document.getElementById('tripIdField').value = tripId;
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        modal.classList.remove('hidden');
    }

    // Modalni yopish va tozalash
    function closeModal() {
        document.getElementById('expenseModal').classList.add('hidden');
        document.getElementById('expenseForm').reset();
    }

    async function viewUser(userId) {
    try {
        const response = await fetch(`${API_BASE}/user/${userId}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (!response.ok) {
            throw new Error(`HTTP xatosi: ${response.status}`);
        }

        const result = await response.json();

        if (!result.success || !result.object) {
            showNotify("Muommo mavjud !", 'Foydalanuvchi ma ºlumotlari yuklanmadi!');
            return;
        }

        const user = result.object;

        // Elementlarni null-safe yashiramiz
        const usersHeader = document.getElementById('usersHeader');
        const userTypeTabs = document.getElementById('userTypeTabs');
        const usersList = document.getElementById('usersList');

        if (usersHeader) usersHeader.classList.add('hidden');
        if (userTypeTabs) userTypeTabs.classList.add('hidden');
        if (usersList) usersList.classList.add('hidden');

        const detailsSection = document.getElementById('userDetailsSection');
        if (!detailsSection) {
            showNotify("Muommo mavjud !", 'userDetailsSection elementi topilmadi!');
            return;
        }
        detailsSection.classList.remove('hidden');

        // Role ga qarab sarlavha
        let roleTitle = '';
        switch (user.role) {
            case 'DRIVER':      roleTitle = 'Haydovchi'; break;
            case 'MANAGER':     roleTitle = 'Menejer'; break;
            case 'ECONOMIST':   roleTitle = 'Iqtisodchi'; break;
            case 'DIRECTOR':    roleTitle = 'Direktor'; break;
            default:            roleTitle = user.role || 'Foydalanuvchi';
        }

        detailsSection.innerHTML = `
            <div class="min-h-screen bg-gray-50 py-8 px-4">
                <div class="max-w-6xl mx-auto">
                    <!-- Ortga tugmasi -->
                    <button onclick="closeUserDetails()" class="mb-6 text-blue-600 hover:underline flex items-center gap-2 text-base font-medium">
                        ‚Üê Ortga
                    </button>

                    <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
                        <!-- Yuqori qism -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 md:p-8">
                            <div class="flex justify-between items-start mb-6">
                                <h2 class="text-2xl md:text-3xl font-bold text-blue-700">${roleTitle} Ma'lumotlari</h2>
                                <button onclick="editUser(${user.id})" class="flex items-center gap-2 px-5 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 font-medium text-sm md:text-base shadow-md transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    Tahrirlash
                                </button>
                            </div>

                            <!-- Asosiy ma'lumotlar -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">F.I.O</p>
                                    <p class="text-lg md:text-xl font-bold text-gray-800 mt-1">${user.fullName || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">Yoshi</p>
                                    <p class="text-lg md:text-xl font-bold text-gray-800 mt-1">${user.age || '-'} yosh</p>
                                </div>
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">Manzil</p>
                                    <p class="text-lg md:text-xl font-bold text-gray-800 mt-1">${user.address || '-'}</p>
                                </div>
                            </div>

                            <!-- Sanalar -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">Tug'ilgan sana</p>
                                    <p class="text-base md:text-lg font-semibold text-gray-800 mt-1">${user.brithDate || user.birthDate || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">Ishga kirgan sana</p>
                                    <p class="text-base md:text-lg font-semibold text-gray-800 mt-1">${user.hireDate || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">Ishdan bo'shagan sana</p>
                                    <p class="text-base md:text-lg font-semibold text-gray-800 mt-1">${user.fireDate ? user.fireDate : 'Hozircha yo'q'}</p>
                                </div>
                            </div>

                            <!-- Identifikatorlar -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">PNFL</p>
                                    <p class="text-base md:text-lg font-semibold text-gray-800 mt-1">${user.pnfl || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">Telefon</p>
                                    <p class="text-base md:text-lg font-semibold text-gray-800 mt-1">${user.phoneNumber || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-xs md:text-sm text-gray-600 font-semibold uppercase tracking-wide">Passport raqami</p>
                                    <p class="text-base md:text-lg font-semibold text-gray-800 mt-1">${user.passportNumber || '-'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Hozirgi Balans -->
                        <div class="bg-white p-6 md:p-8 border-b border-gray-200">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">Hozirgi Balans</h3>
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">$1,950</span>
                                    <span class="text-lg md:text-xl text-gray-500 font-semibold">USD</span>
                                </div>
                            </div>

                            <!-- Statistika -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border-l-4 border-green-500">
                                    <p class="text-xs text-gray-600 font-medium">Jami Daromad</p>
                                    <p class="text-xl md:text-2xl font-bold text-gray-800 mt-2">$3,200</p>
                                </div>
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border-l-4 border-red-500">
                                    <p class="text-xs text-gray-600 font-medium">Jami Xarajat</p>
                                    <p class="text-xl md:text-2xl font-bold text-gray-800 mt-2">$1,250</p>
                                </div>
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border-l-4 border-yellow-500">
                                    <p class="text-xs text-gray-600 font-medium">Avanslar</p>
                                    <p class="text-xl md:text-2xl font-bold text-gray-800 mt-2">$500</p>
                                </div>
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border-l-4 border-purple-500">
                                    <p class="text-xs text-gray-600 font-medium">Bonuslar</p>
                                    <p class="text-xl md:text-2xl font-bold text-gray-800 mt-2">$300</p>
                                </div>
                            </div>

                            <!-- Tugmalar -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onclick="openSalaryModal(${user.id})" class="flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold text-sm md:text-base shadow-md transition-all hover:-translate-y-1">
                                    <span>üí∞</span>
                                    <span>Oylik Yozish</span>
                                </button>
                                <button onclick="openAdvanceModal(${user.id})" class="flex items-center justify-center gap-2 px-6 py-3 bg-orange-600 text-white rounded-xl hover:bg-orange-700 font-semibold text-sm md:text-base shadow-md transition-all hover:-translate-y-1">
                                    <span>üí≥</span>
                                    <span>Avans Berish</span>
                                </button>
                                <button onclick="openBonusModal(${user.id})" class="flex items-center justify-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 font-semibold text-sm md:text-base shadow-md transition-all hover:-translate-y-1">
                                    <span>üéÅ</span>
                                    <span>Bonus Berish</span>
                                </button>
                                <button onclick="openReportModal(${user.id})" class="flex items-center justify-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-semibold text-sm md:text-base shadow-md transition-all hover:-translate-y-1">
                                    <span>üìä</span>
                                    <span>Hisobot Yuklash</span>
                                </button>
                            </div>
                        </div>

                        <!-- Bajarilgan Resylar -->
                        <div class="bg-gray-50 p-6 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">Bajarilgan Resylar</h3>
                                <div class="flex gap-2 bg-white p-1 rounded-xl shadow-sm overflow-x-auto">
                                    <button onclick="filterTasks('all', this)" class="filter-tab active px-4 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap">Barchasi</button>
                                    <button onclick="filterTasks('completed', this)" class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap">Bajarilgan</button>
                                    <button onclick="filterTasks('in-progress', this)" class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap">Jarayonda</button>
                                    <button onclick="filterTasks('pending', this)" class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap">Kutilmoqda</button>
                                </div>
                            </div>

                            <div class="space-y-4" id="taskList">
                                <!-- Task 1 -->
                                <div class="task-item bg-white rounded-xl p-5 border-l-4 border-green-500 cursor-pointer hover:shadow-md transition-all" data-status="completed">
                                    <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-3">
                                        <div>
                                            <h4 class="text-base md:text-lg font-bold text-gray-800">Toshkent - Samarqand yo'nalishi</h4>
                                            <p class="text-sm text-gray-500 mt-1">26.01.2026</p>
                                        </div>
                                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold uppercase">Bajarilgan</span>
                                    </div>
                                    <div class="flex flex-wrap gap-4 md:gap-6 text-sm text-gray-600">
                                        <div class="flex items-center gap-2">
                                            <span>üìç</span>
                                            <span class="font-medium">420 km</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>üíµ</span>
                                            <span class="font-medium">$350</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>‚è±Ô∏è</span>
                                            <span class="font-medium">6 soat</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task 2 -->
                                <div class="task-item bg-white rounded-xl p-5 border-l-4 border-blue-500 cursor-pointer hover:shadow-md transition-all" data-status="in-progress">
                                    <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-3">
                                        <div>
                                            <h4 class="text-base md:text-lg font-bold text-gray-800">Toshkent - Buxoro yo'nalishi</h4>
                                            <p class="text-sm text-gray-500 mt-1">27.01.2026</p>
                                        </div>
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold uppercase">Jarayonda</span>
                                    </div>
                                    <div class="flex flex-wrap gap-4 md:gap-6 text-sm text-gray-600">
                                        <div class="flex items-center gap-2">
                                            <span>üìç</span>
                                            <span class="font-medium">575 km</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>üíµ</span>
                                            <span class="font-medium">$480</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>‚è±Ô∏è</span>
                                            <span class="font-medium">8 soat</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task 3 -->
                                <div class="task-item bg-white rounded-xl p-5 border-l-4 border-yellow-500 cursor-pointer hover:shadow-md transition-all" data-status="pending">
                                    <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-3">
                                        <div>
                                            <h4 class="text-base md:text-lg font-bold text-gray-800">Toshkent - Andijon yo'nalishi</h4>
                                            <p class="text-sm text-gray-500 mt-1">28.01.2026</p>
                                        </div>
                                        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-xs font-bold uppercase">Kutilmoqda</span>
                                    </div>
                                    <div class="flex flex-wrap gap-4 md:gap-6 text-sm text-gray-600">
                                        <div class="flex items-center gap-2">
                                            <span>üìç</span>
                                            <span class="font-medium">365 km</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>üíµ</span>
                                            <span class="font-medium">$320</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>‚è±Ô∏è</span>
                                            <span class="font-medium">5 soat</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task 4 -->
                                <div class="task-item bg-white rounded-xl p-5 border-l-4 border-green-500 cursor-pointer hover:shadow-md transition-all" data-status="completed">
                                    <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-3">
                                        <div>
                                            <h4 class="text-base md:text-lg font-bold text-gray-800">Toshkent - Namangan yo'nalishi</h4>
                                            <p class="text-sm text-gray-500 mt-1">25.01.2026</p>
                                        </div>
                                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold uppercase">Bajarilgan</span>
                                    </div>
                                    <div class="flex flex-wrap gap-4 md:gap-6 text-sm text-gray-600">
                                        <div class="flex items-center gap-2">
                                            <span>üìç</span>
                                            <span class="font-medium">330 km</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>üíµ</span>
                                            <span class="font-medium">$290</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>‚è±Ô∏è</span>
                                            <span class="font-medium">5 soat</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task 5 -->
                                <div class="task-item bg-white rounded-xl p-5 border-l-4 border-green-500 cursor-pointer hover:shadow-md transition-all" data-status="completed">
                                    <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-3">
                                        <div>
                                            <h4 class="text-base md:text-lg font-bold text-gray-800">Toshkent - Farg'ona yo'nalishi</h4>
                                            <p class="text-sm text-gray-500 mt-1">24.01.2026</p>
                                        </div>
                                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold uppercase">Bajarilgan</span>
                                    </div>
                                    <div class="flex flex-wrap gap-4 md:gap-6 text-sm text-gray-600">
                                        <div class="flex items-center gap-2">
                                            <span>üìç</span>
                                            <span class="font-medium">380 km</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>üíµ</span>
                                            <span class="font-medium">$340</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span>‚è±Ô∏è</span>
                                            <span class="font-medium">6 soat</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .filter-tab {
                    color: #6b7280;
                }
                .filter-tab.active {
                    background: #3b82f6;
                    color: white;
                }
                .filter-tab:hover:not(.active) {
                    background: #f3f4f6;
                    color: #1f2937;
                }
            </style>

            <script>
                function filterTasks(status, button) {
                    // Remove active from all tabs
                    document.querySelectorAll('.filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Add active to clicked tab
                    button.classList.add('active');
                    
                    // Filter tasks
                    const tasks = document.querySelectorAll('.task-item');
                    tasks.forEach(task => {
                        if (status === 'all') {
                            task.style.display = 'block';
                        } else {
                            if (task.dataset.status === status) {
                                task.style.display = 'block';
                            } else {
                                task.style.display = 'none';
                            }
                        }
                    });
                }
            </script>
        `;

        detailsSection.scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error('View user error:', error);
        showNotify("Ma ºlumot yuklashda xatolik!", "Console ni tekshiring (F12).");
    }
}

    function closeUserDetails() {
        const detailsSection = document.getElementById('userDetailsSection');
        if (detailsSection) detailsSection.classList.add('hidden');

        const usersHeader = document.getElementById('usersHeader');
        const userTypeTabs = document.getElementById('userTypeTabs');
        const usersList = document.getElementById('usersList');

        if (usersHeader) usersHeader.classList.remove('hidden');
        if (userTypeTabs) userTypeTabs.classList.remove('hidden');
        if (usersList) usersList.classList.remove('hidden');
    }

    // Trip Modal Functions
    function openAddTripModal() {
        loadTripFormData();
        document.getElementById('addTripModal').classList.add('active');
    }

    function closeAddTripModal() {
        document.getElementById('addTripModal').classList.remove('active');
        document.getElementById('addTripForm').reset();
    }

    async function loadTripFormData() {
        try {
            const [trucksRes, driversRes] = await Promise.all([
                fetch(`${API_BASE}/truck/list-truck`, { headers: { 'Authorization': `Bearer ${authToken}` }}),
                fetch(`${API_BASE}/user/list-driver`, { headers: { 'Authorization': `Bearer ${authToken}` }})
            ]);

            const trucks = await trucksRes.json();
            const drivers = await driversRes.json();

            if (trucks.success) {
                const truckSelect = document.getElementById('tripTruckSelect');
                truckSelect.innerHTML = '<option value="">Tanlang</option>' +
                    trucks.object.map(t => `<option value="${t.id}">${t.truckNumber} - ${t.modelName}</option>`).join('');
            }

            if (drivers.success) {
                const driverSelect = document.getElementById('tripDriverSelect');
                driverSelect.innerHTML = '<option value="">Tanlang</option>' +
                    drivers.object.map(d => `<option value="${d.id}">${d.fullName}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading trip form data:', error);
        }
    }

    async function loadTrips() {
        try {
            const response = await fetch(`${API_BASE}/trip/getAll`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            const data = await response.json();

            if (!data.success) return;

            const tripsList = document.getElementById('tripsList');
            tripsList.className = "grid grid-cols-1 lg:grid-cols-2 gap-4";
            tripsList.innerHTML = data.object.map(trip => {
                const statusLabels = {
                    'IN_PROGRESS': 'Jarayonda',
                    'WAITING_CONFIRMATION': 'Kutilmoqda',
                    'COMPLETED': 'Tugatilgan'
                };

                // F.I.O dan faqat ismni ajratib olish (2-so'zni oladi)
                // Agar F.I.O bo'sh bo'lsa yoki bitta so'z bo'lsa, borini chiqaradi
                const firstName = trip.fullName ? (trip.fullName.split(' ')[1] || trip.fullName.split(' ')[0]) : "Noma'lum";

                return `
    <div class="bg-white border border-gray-100 rounded-2xl p-5 hover:shadow-md transition-all duration-300 relative overflow-hidden group">
        <div class="absolute left-0 top-0 bottom-0 w-1 ${
                    trip.tripStatus === 'IN_PROGRESS' ? 'bg-blue-300' :
                        trip.tripStatus === 'WAITING_CONFIRMATION' ? 'bg-amber-300' :
                            'bg-green-300'
                }"></div>

        <div class="flex justify-between items-center pl-2">
            <div class="space-y-4">
                <div class="flex items-center gap-3">
                    <span class="bg-slate-50 text-slate-400 text-[10px] font-bold px-2 py-0.5 rounded border border-slate-100">
                        #${trip.id}
                    </span>
                    <p class="font-bold text-lg text-slate-600 tracking-tight">
                        ${trip.routeFrom} <span class="text-slate-300 mx-1">‚Üí</span> ${trip.routeTo}
                    </p>
                </div>

                <div class="flex items-center gap-6">
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">Haydovchi</p>
                        <span class="text-blue-500 font-bold text-xs bg-blue-50/40 px-3 py-1 rounded-md border border-blue-100/50 block shadow-sm">
                            üë§ ${firstName}
                        </span>
                    </div>
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">Mashina</p>
                        <span class="text-indigo-500 font-bold text-xs bg-indigo-50/40 px-3 py-1 rounded-md border border-indigo-100/50 block shadow-sm">
                            üöõ ${trip.truckNumber}
                        </span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-5">
                <span class="px-2 py-0.5 rounded-md text-[9px] font-bold uppercase tracking-wider border ${
                    trip.tripStatus === 'IN_PROGRESS' ? 'bg-blue-50/50 text-blue-400 border-blue-100' :
                        trip.tripStatus === 'WAITING_CONFIRMATION' ? 'bg-amber-50/50 text-amber-500 border-amber-100' :
                            'bg-green-50/50 text-green-500 border-green-100'
                }">
                    ${statusLabels[trip.tripStatus] || trip.tripStatus}
                </span>

                <button onclick="showTripDetails(${trip.id})"
                        class="p-2.5 bg-white border border-blue-100 rounded-xl text-blue-500 hover:bg-blue-50 transition-colors shadow-sm shadow-blue-50/50"
                        title="Batafsil">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    `;
            }).join('');

        } catch (error) {
            console.error('Error loading trips:', error);
        }
    }

    // Trip Details (INLINE, MODAL EMAS)
    async function showTripDetails(tripId) {
        try {
            const response = await fetch(`${API_BASE}/trip/${tripId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            const data = await response.json();
            if (!data.success) return;

            const trip = data.object;

            // Status COMPLETED bo'lsa tahrirlash bloklanadi
            const isLocked = trip.tripStatus === 'COMPLETED';
            const hideIfLocked = isLocked ? 'hidden' : '';

            // Statuslarni o'zbekchalashtirish va rang berish
            const statusMap = {
                'IN_PROGRESS': { label: 'Jarayonda', class: 'bg-green-100 text-green-700 ring-green-200' },
                'COMPLETED': { label: 'Tugatilgan', class: 'bg-blue-100 text-blue-700 ring-blue-200' }
            };
            const currentStatus = statusMap[trip.tripStatus] || { label: trip.tripStatus, class: 'bg-gray-100 text-gray-700 ring-gray-200' };

            document.getElementById('tripsList').classList.add('hidden');
            const detailsSection = document.getElementById('tripDetailsSection');

            detailsSection.innerHTML = `
<div class="bg-[#f2f2f7] min-h-screen p-4 md:p-6 font-sans antialiased text-[#1c1c1e]">
    <div class="max-w-7xl mx-auto bg-white rounded-[32px] shadow-sm border border-gray-200/50 p-6 md:p-8">

        <div class="flex justify-between items-center mb-6">
            <div class="flex gap-3">
                <button onclick="closeTripDetails()" class="px-5 py-2.5 bg-gray-100 hover:bg-gray-200 rounded-2xl text-[13px] font-bold transition-all active:scale-95 text-gray-600">
                    ‚Üê Ortga
                </button>
                <button onclick="printTripCheck(${trip.id})" class="px-5 py-2.5 bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 rounded-2xl text-[13px] font-bold transition-all flex items-center gap-2">
                    üñ®Ô∏è Chek chiqarish
                </button>
            </div>
            <div class="flex items-center gap-3">
                <h3 class="text-xl font-bold text-slate-800 tracking-tight">Reys Ma'lumotlari</h3>
                ${isLocked ? '<span class="px-3 py-1 bg-orange-50 text-orange-600 rounded-lg text-[10px] font-bold border border-orange-100">‚åõ TASDIQ KUTILMOQDA</span>' : ''}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

            <div class="bg-[#f2f7ff] rounded-[24px] p-7 border border-[#d1e3ff] shadow-sm">
                <h4 class="text-2xl font-bold text-blue-700 mb-8 tracking-tight flex items-center gap-3">
                    ${trip.routeFrom} <span class="text-blue-300 font-light">‚Üí</span> ${trip.routeTo}
                </h4>

                <div class="grid grid-cols-2 gap-y-8">
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Mashina raqami</span>
                        <span class="text-lg font-bold text-slate-700 tracking-tight uppercase">${trip.truckNumber}</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Mas'ul haydovchi</span>
                        <span class="text-lg font-bold text-slate-700 tracking-tight">${trip.driverFullName}</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Hozirgi holat</span>
                        <div>
                            <span class="px-3 py-1 ${currentStatus.class} rounded-lg text-[10px] font-bold uppercase tracking-wide ring-1 shadow-sm">
                               ‚óè ${currentStatus.label}
                            </span>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Safar davomiyligi</span>
                        <span class="text-lg font-bold text-slate-700 tracking-tight">${trip.tripDuration} kun</span>
                    </div>
                    <div class="flex flex-col border-t border-blue-50 pt-3">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Boshlanish sanasi</span>
                        <span class="text-[14px] font-semibold text-slate-500 tracking-tight">${trip.startedDate}</span>
                    </div>
                    <div class="flex flex-col border-t border-blue-50 pt-3">
                        <span class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1 italic">Tugallanish sanasi</span>
                        <span class="text-[14px] font-semibold text-slate-500 tracking-tight">${trip.finishedDate || 'Hozirda'}</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="bg-[#f0fdf4] rounded-[24px] p-6 border border-green-100 shadow-sm">
                    <h5 class="text-[10px] font-bold text-green-700 uppercase tracking-widest mb-4 italic">Moliyaviy ko'rsatkichlar</h5>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center py-1.5 border-b border-green-50">
                            <span class="text-[13px] font-medium text-slate-500 italic">Ketish narxi:</span>
                            <span class="text-[15px] font-bold text-green-600 tracking-tighter">$${trip.incomeOutUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center py-1.5 border-b border-green-50">
                            <span class="text-[13px] font-medium text-slate-500 italic">Qaytish narxi:</span>
                            <span class="text-[15px] font-bold text-green-600 tracking-tighter">$${trip.incomeBackUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center pt-3">
                            <span class="text-lg font-bold text-slate-700 italic uppercase tracking-tight">Jami tushum:</span>
                            <span class="text-2xl font-bold text-slate-800 tracking-tighter">$${trip.totalIncomeUsd.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-[#fff1f2] rounded-[24px] p-6 border border-red-100 shadow-sm">
                    <h5 class="text-[10px] font-bold text-red-700 uppercase tracking-widest mb-4 italic text-red-700">Xarajatlar tarkibi</h5>
                    <div class="grid grid-cols-2 gap-x-8 gap-y-2">
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Yoqilg'i:</span>
                            <span class="text-[12px] font-bold text-red-600 tracking-tight">$${trip.totalFuelCostUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Ta'mir:</span>
                            <span class="text-[12px] font-bold text-red-600 tracking-tight">$${trip.truckExpensesTotalUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Yo'l haqi:</span>
                            <span class="text-[12px] font-bold text-red-600 tracking-tight">$${trip.totalTripExpensesUsd.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-slate-400 italic">Oylik:</span>
                            <span class="text-[12px] font-bold text-slate-600 tracking-tight">$${trip.driverIncomeUsd.toFixed(2)}</span>
                        </div>
                         <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-semibold text-orange-400 italic">Shaxsiy:</span>
                            <span class="text-[12px] font-bold text-orange-600 tracking-tight">-$${(trip.personalExpenseDriver || 0).toFixed(2)}</span>
                        </div>
                         <div class="flex justify-between py-1 border-b border-red-50">
                            <span class="text-[11px] font-bold text-blue-600 italic">Sof oylik:</span>
                            <span class="text-[12px] font-bold text-blue-700 tracking-tight">$${(trip.driverIncomeUsd - (trip.personalExpenseDriver || 0)).toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4">
                        <span class="text-[13px] font-bold text-slate-600 uppercase italic tracking-wide">Umumiy xarajat:</span>
                        <span class="text-xl font-bold text-red-600 tracking-tighter">${trip.totalExpense}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-blue-700 to-blue-900 rounded-[24px] p-6 mb-10 shadow-xl shadow-blue-100 flex justify-between items-center relative overflow-hidden">
            <div class="absolute right-0 top-0 opacity-10 scale-150 pointer-events-none text-8xl">üí∞</div>
            <div>
                <p class="text-[10px] font-bold text-blue-200 uppercase tracking-[0.2em] italic mb-1">Reysdan qolgan Sof Foyda</p>
                <h2 class="text-5xl font-bold text-white tracking-tighter">$${trip.profitUsd.toFixed(2)}</h2>
            </div>
            <div class="text-right hidden md:block border-l border-blue-400/30 pl-6">
                <p class="text-[10px] text-blue-100 uppercase font-bold tracking-tighter leading-tight italic">
                    Barcha operatsion xarajatlar va<br>oyliklar chegirilgan yakuniy foyda
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">‚õΩ Yonilg'i sarfi</h5>
                    <button onclick="addFuel(${trip.id}, ${trip.truckId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    ${trip.fuelEntries?.length > 0 ? trip.fuelEntries.map(fuel => `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl group hover:bg-white border border-transparent hover:border-blue-100 transition-all">
                            <div>
                                <p class="font-bold text-slate-700 text-[13px] tracking-tight">${fuel.gasStationName}</p>
                                <p class="text-[10px] text-gray-400 font-semibold uppercase tracking-tighter">${fuel.location} | ${fuel.fuelDate}</p>
                            </div>
                            <div class="text-right flex items-center gap-4">
                                <div>
                                    <p class="font-bold text-blue-600 text-[14px] tracking-tight">$${fuel.totalAmountUsd.toFixed(2)}</p>
                                    <p class="text-[9px] text-gray-400 font-bold uppercase">${fuel.liters}L</p>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editFuel(${fuel.id})" class="hover:bg-blue-50 p-2 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteFuel(${fuel.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-2 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold">
                     <span class="text-gray-400 text-[10px] uppercase italic tracking-widest">Jami xarajat:</span>
                     <span class="text-xl text-slate-800 tracking-tighter">$${trip.totalFuelCostUsd.toFixed(2)}</span>
                     <span class="text-xl text-slate-800 tracking-tighter">${trip.totalLiters} L</span>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">üí≥ Yo'l xarajatlari</h5>
                    <button onclick="addTripExpense(${trip.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    ${trip.tripExpenseResDto?.length > 0 ? trip.tripExpenseResDto.map(exp => `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl group hover:bg-white border border-transparent hover:border-red-100 transition-all">
                            <div>
                                <p class="font-bold text-slate-700 text-[13px] uppercase italic tracking-tight">${exp.type}</p>
                                <p class="text-[10px] text-gray-400 font-semibold tracking-tighter uppercase">${exp.expenseDate}</p>
                            </div>
                            <div class="text-right flex items-center gap-4">
                                <p class="font-bold text-red-600 text-[14px] tracking-tight">$${exp.amountUsd.toFixed(2)}</p>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editTripExpense(${exp.id})" class="hover:bg-blue-50 p-2 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteTripExpense(${exp.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-2 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold text-slate-800">
                     <span class="text-gray-400 text-[10px] uppercase italic tracking-widest">Jami summa:</span>
                     <span class="text-xl tracking-tighter">$${trip.totalTripExpensesUsd.toFixed(2)}</span>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">üîß Mashina ta'mirlash</h5>
                    <button onclick="addTruckExpense(${trip.id},${trip.truckId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    ${trip.truckExpenses?.length > 0 ? trip.truckExpenses.map(exp => `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl group hover:bg-white border border-transparent hover:border-orange-100 transition-all">
                            <span class="font-bold text-slate-700 text-[13px] tracking-tight">${exp.truckExpenseType}</span>
                            <div class="text-right flex items-center gap-4">
                                <span class="font-bold text-red-600 text-[14px] tracking-tight">$${exp.amountUsd.toFixed(2)}</span>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editTruckExpense(${exp.id})" class="hover:bg-blue-50 p-2 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteTruckExpense(${exp.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-2 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold">
                    <span class="text-gray-400 text-[10px] uppercase italic tracking-widest">Jami:</span>
                    <span class="text-xl text-slate-800 tracking-tighter">$${trip.truckExpensesTotalUsd.toFixed(2)}</span>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-[28px] p-6 flex flex-col h-[400px] shadow-sm">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h5 class="font-bold text-slate-800 italic text-[15px]">üë§ Haydovchi balansi</h5>
                    <button onclick="addDriverBalance(${trip.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-[11px] font-bold transition-all ${hideIfLocked}">+ QO'SHISH</button>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                    ${trip.userBalanceResponseList && trip.userBalanceResponseList.length > 0 ? trip.userBalanceResponseList.map(bal => `
                        <div class="flex justify-between items-center p-3 ${bal.paymentType === 'SALARY' ? 'bg-green-50' : 'bg-orange-50'} rounded-2xl group border border-transparent hover:border-gray-200 transition-all">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-gray-700 italic uppercase tracking-tighter">${bal.paymentType === 'SALARY' ? 'üí∞ OYLIK' : 'üõí SHAXSIY'}</span>
                                <span class="text-[9px] text-gray-400 italic truncate w-32">${bal.description || ''}</span>
                            </div>
                            <div class="text-right flex items-center gap-3">
                                <div>
                                    <p class="font-bold text-[13px] ${bal.paymentType === 'SALARY' ? 'text-green-600' : 'text-orange-600'} tracking-tight">
                                        ${bal.paymentType === 'SALARY' ? '+' : '-'}$${bal.amountUsd.toFixed(2)}
                                    </p>
                                    <p class="text-[8px] text-gray-400 font-bold uppercase">${bal.operationDate}</p>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${hideIfLocked}">
                                    <button onclick="editDriverBalance(${bal.id})" class="hover:bg-blue-50 p-1.5 rounded-lg">‚úèÔ∏è</button>
                                    <button onclick="deleteDriverBalance(${bal.id}, ${trip.id})" class="hover:bg-red-50 text-red-500 p-1.5 rounded-lg">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-400 text-center py-10 italic text-sm">Ma\'lumot yo\'q</p>'}
                </div>
                <div class="mt-4 pt-4 border-t">
                    <button onclick="${isLocked ? '' : `toggleDriverPayment(${trip.id})`}"
                            class="w-full py-4 rounded-2xl font-bold text-[11px] tracking-[0.1em] shadow-md transition-all active:scale-95 ${
                trip.driverIncomePaid ? 'bg-green-500 text-white shadow-green-100' : 'bg-red-500 text-white shadow-red-100'
            }">
                        ${trip.driverIncomePaid ? '‚úÖ TO‚ÄòLANGAN' : '‚ùå TO‚ÄòLANMAGAN'}
                    </button>
                </div>
            </div>

        </div>

        <div class="mt-12 pt-8 border-t flex justify-center">
            <button onclick="updateTripStatus(${trip.id}, '${trip.tripStatus}')"
                    class="px-20 py-5 rounded-[24px] font-bold text-[13px] tracking-[0.15em] shadow-xl transition-all transform hover:scale-[1.02] active:scale-95 text-white ${
                isLocked ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-100' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-100'
            }">
                ${isLocked ? 'üîì TAHRIRLASHNI OCHISH' : '‚úÖ REYSNI TASDIQLASH VA YAKUNLASH'}
            </button>
        </div>
    </div>
</div>
`;

            detailsSection.classList.remove('hidden');
            detailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

        } catch (error) {
            console.error('Error:', error);
            showNotify("Xatolik", "Ma'lumotlarni yuklashda xatolik yuz berdi", "error");
        }
    }

    async function printTripCheck(tripId) {
    try {
        // 0. Eski print-section bo‚Äòlsa o‚Äòchiramiz
        const oldSection = document.getElementById('print-section');
        if (oldSection) oldSection.remove();

        // 1. Trip ma'lumotini olish
        const response = await fetch(`${API_BASE}/trip/${tripId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });

        const data = await response.json();
        if (!data.success) return;

        const trip = data.object;

        // 2. QR code URL (scanner ochilishi uchun)
        const qrData = `https://track-menejment2.onrender.com/trips/${trip.id}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(qrData)}`;

        // 3. Xarajatlarni hisoblash (frontend faqat yig‚Äòadi)
        const totalExpenses =
            (trip.driverIncomeUsd || 0) +
            (trip.driverPersonalExpenseUsd || 0) +
            (trip.totalTruckExpenseUsd || 0) +
            (trip.totalTripExpenseUsd || 0) +
            (trip.totalFuelUsd || 0);

        // 4. Print konteyner
        const printContainer = document.createElement('div');
        printContainer.id = 'print-section';

        printContainer.innerHTML = `
        <div style="width:80mm; font-family:'Courier New', monospace; padding:10px; color:#000; background:#fff;">
            
            <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:8px; margin-bottom:8px;">
                <h2 style="margin:0; font-size:16px;">LOGISTICS CHECK</h2>
                <p style="margin:4px 0; font-size:10px;">
                    Sana: ${new Date().toLocaleString()}
                </p>
            </div>

            <div style="font-size:11px; line-height:1.5;">
                <div style="display:flex; justify-content:space-between;">
                    <span>Reys:</span>
                    <span>${trip.routeFrom} - ${trip.routeTo}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Mashina:</span>
                    <span>${trip.truckNumber}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Haydovchi:</span>
                    <span>${trip.driverFullName}</span>
                </div>
            </div>

            <div style="border-top:1px solid #000; margin-top:8px; padding-top:6px; font-size:11px;">
                <div style="display:flex; justify-content:space-between;">
                    <span>Daromad:</span>
                    <b>$${trip.totalIncomeUsd.toFixed(2)}</b>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Jami xarajat:</span>
                    <b>-$${totalExpenses.toFixed(2)}</b>
                </div>
            </div>

            <div style="border-top:2px solid #000; margin-top:8px; padding-top:6px; display:flex; justify-content:space-between; font-size:14px; font-weight:bold;">
                <span>SOF FOYDA:</span>
                <span>$${trip.profitUsd.toFixed(2)}</span>
            </div>

            <div style="margin-top:15px; text-align:center;">
                <img src="${qrUrl}" style="width:80px; height:80px;" />
                <div style="font-size:9px; margin-top:4px;">
                    ID: #TRP-${trip.id}
                </div>
            </div>
        </div>
        `;

        // 5. Print CSS
        const style = document.createElement('style');
        style.innerHTML = `
            @media print {
                body * {
                    visibility: hidden;
                }
                #print-section, #print-section * {
                    visibility: visible;
                }
                #print-section {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 80mm;
                }
                body {
                    margin: 0;
                }
            }
        `;

        document.body.appendChild(style);
        document.body.appendChild(printContainer);

        // 6. QR yuklanishini kutib print qilish
        setTimeout(() => {
            window.print();

            // 7. Tozalash
            printContainer.remove();
            style.remove();
        }, 500);

    } catch (error) {
        console.error('Print error:', error);
    }
}

    //trip expense
    // 1. Modalni ochish (Ochilganda ham tozalanadi)
    function addTruckExpense(tripId, truckId) {
        const form = document.getElementById('truckExpenseForm');
        form.reset();

        document.getElementById('teTripId').value = tripId;
        document.getElementById('teTruckId').value = truckId;
        document.getElementById('teDate').value = new Date().toISOString().split('T')[0];

        document.getElementById('truckExpenseModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeTruckExpenseModal() {
        const modal = document.getElementById('truckExpenseModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('truckExpenseForm').reset();
    }

    document.getElementById('truckExpenseForm').onsubmit = async function(e) {
        e.preventDefault();

        const amountUsd = parseFloat(document.getElementById('teAmountUsd').value);
        const tripId = document.getElementById('teTripId').value;

        if (!amountUsd || amountUsd <= 0) {
            alert("USD summa 0 dan katta bo'lishi shart!");
            return;
        }

        const payload = {
            truckId: parseInt(document.getElementById('teTruckId').value),
            tripId: parseInt(tripId),
            truckExpenseType: document.getElementById('teType').value,
            amountUsd: amountUsd,
            amountLocal: parseFloat(document.getElementById('teAmountLocal').value) || 0,
            localCurrency: document.getElementById('teLocalCurrency').value,
            description: document.getElementById('teDescription').value,
            expenseDate: document.getElementById('teDate').value
        };

        const response = await fetch(`${API_BASE}/truck-expense/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (data.success) {
            document.getElementById('truckExpenseForm').reset();
            showTripDetails(tripId);
            closeTruckExpenseModal();
            showNotify("Muvaffaqiyat", "Xarajat saqlandi", "success");
        } else {
            console.error('Error:', error);
            showNotify("Xato",data.message || "Xatolik!");
        }
    };

    async function updateTripStatus(tripId, currentStatus) {
        const nextStatus = (currentStatus === 'COMPLETED') ? 'IN_PROGRESS' : 'COMPLETED';
        const isFinishing = nextStatus === 'COMPLETED';

        // SweetAlert Tasdiqlash oynasi
        const result = await Swal.fire({
            title: isFinishing ? "Xarajatlarni tasdiqlash" : "Tahrirlashni ochish",
            text: isFinishing
                ? "Barcha ma'lumotlar to'g'riligiga ishonchingiz komilmi? Reys yakunlanadi."
                : "Reysni qaytadan tahrirlash rejimiga o'tkazmoqchimisiz?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: isFinishing ? '‚úÖ Tasdiqlash' : 'üîì Ochish',
            cancelButtonText: 'Bekor qilish',
            background: 'rgba(255, 255, 255, 0.95)',
            backdrop: `rgba(0,0,0,0.2) blur(4px)`,
            customClass: {
                popup: 'apple-popup',
                confirmButton: `apple-button px-8 py-3 ${isFinishing ? 'bg-green-600' : 'bg-orange-500'} text-white rounded-lg mx-2 font-bold`,
                cancelButton: 'apple-button px-8 py-3 bg-gray-300 text-gray-700 rounded-lg mx-2 font-bold'
            },
            buttonsStyling: false
        });

        if (result.isConfirmed) {
            try {
                // 1. Joriy tripni GET qilish
                const getRes = await fetch(`${API_BASE}/trip/${tripId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const getData = await getRes.json();

                if (!getData.success) throw new Error("Ma'lumot topilmadi");

                const tripData = getData.object;
                tripData.tripStatus = nextStatus; // Faqat statusni yangilaymiz

                // 2. Yangilangan ob'ektni PUT qilish
                const response = await fetch(`${API_BASE}/trip/${tripId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tripData)
                });

                const resData = await response.json();

                if (resData.success) {
                    showTripDetails(tripId); // UI ni yangilash
                    showNotify(
                        "Muvaffaqiyatli",
                        isFinishing ? "Xarajatlar tasdiqlandi va reys yakunlandi" : "Reys tahrirlash uchun ochildi",
                        "success"
                    );
                } else {
                    showNotify("Xatolik", resData.message || "Xatolik yuz berdi", "error");
                }
            } catch (error) {
                console.error(error);
                showNotify("Xatolik", "Server bilan bog'lanishda xatolik", "error");
            }
        }
    }

    async function deleteFuel(fuelId, tripId) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "O'chirilgan ma'lumotni qayta tiklab bo'lmaydi!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, o‚Äòchirilsin!',
            cancelButtonText: 'Bekor qilish'
        }).then(async (result) => {

            if (!result.isConfirmed) return;

            let response;

            // üîπ 1. Faqat FETCH uchun try/catch
            try {
                response = await fetch(`${API_BASE}/fuel/delete/${fuelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (networkError) {
                console.error("NETWORK ERROR:", networkError);
                showNotify("Tarmoq xatosi!", "Server bilan aloqa yo'q.", 'error');
                return;
            }

            // üîπ 2. HTTP status tekshirish
            if (!response.ok) {
                showNotify(
                    "Xatolik!",
                    `Server xatosi: ${response.status}`,
                    'error'
                );
                return;
            }

            // üîπ 3. JSON parsing (xavfsiz)
            let data = { success: true };

            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : { success: true };
            } catch (jsonError) {
                console.warn("JSON parse xatosi:", jsonError);
            }

            // üîπ 4. Business logic
            if (data.success) {
                showNotify(
                    "O'chirildi!",
                    data.message || "Yoqilg'i xarajati muvaffaqiyatli o'chirildi.",
                    'success'
                );

                // üîπ 5. UI yangilash (xavfsiz)
                try {
                    showTripDetails(tripId);
                } catch (uiError) {
                    console.error("loadTripDetails xatosi:", uiError);
                }

            } else {
                showNotify(
                    "Xatolik!",
                    data.message || "O'chirishda xatolik yuz berdi",
                    'error'
                );
            }
        });
    }
    // 1. MASHINA TA'MIRLASH XARAJATINI O'CHIRISH (truck-expense)
    async function deleteTruckExpense(expenseId, tripId) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "O'chirilgan ma'lumotni qayta tiklab bo'lmaydi!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, o‚Äòchirilsin!',
            cancelButtonText: 'Bekor qilish'
        }).then(async (result) => {
            if (!result.isConfirmed) return;

            let response;
            try {
                response = await fetch(`${API_BASE}/truck-expense/${expenseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (networkError) {
                console.error("NETWORK ERROR:", networkError);
                showNotify("Tarmoq xatosi!", "Server bilan aloqa yo'q.", 'error');
                return;
            }

            if (!response.ok) {
                showNotify("Xatolik!", `Server xatosi: ${response.status}`, 'error');
                return;
            }

            let data = { success: true };
            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : { success: true };
            } catch (jsonError) {
                console.warn("JSON parse xatosi:", jsonError);
            }

            if (data.success) {
                showNotify("O'chirildi!", "Mashina xarajati muvaffaqiyatli o'chirildi.", 'success');
                showTripDetails(tripId); // UI yangilash
            } else {
                showNotify("Xatolik!", data.message || "O'chirishda xatolik yuz berdi", 'error');
            }
        });
    }

    // 2. YO'L XARAJATINI O'CHIRISH (trip-expense)
    async function deleteTripExpense(expenseId, tripId) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "O'chirilgan ma'lumotni qayta tiklab bo'lmaydi!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ha, o‚Äòchirilsin!',
            cancelButtonText: 'Bekor qilish'
        }).then(async (result) => {
            if (!result.isConfirmed) return;

            let response;
            try {
                response = await fetch(`${API_BASE}/trip-expense/${expenseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (networkError) {
                console.error("NETWORK ERROR:", networkError);
                showNotify("Tarmoq xatosi!", "Server bilan aloqa yo'q.", 'error');
                return;
            }

            if (!response.ok) {
                showNotify("Xatolik!", `Server xatosi: ${response.status}`, 'error');
                return;
            }

            let data = { success: true };
            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : { success: true };
            } catch (jsonError) {
                console.warn("JSON parse xatosi:", jsonError);
            }

            if (data.success) {
                showNotify("O'chirildi!", "Yo'l xarajati muvaffaqiyatli o'chirildi.", 'success');
                showTripDetails(tripId); // UI yangilash
            } else {
                showNotify("Xatolik!", data.message || "O'chirishda xatolik yuz berdi", 'error');
            }
        });
    }

    function closeTripDetails() {
        document.getElementById('tripDetailsSection').classList.add('hidden');
        document.getElementById('tripsList').classList.remove('hidden');
    }
    // Clos modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
    // Check for existing token on page load
    window.addEventListener('load', () => {
        const savedToken = localStorage.getItem('authToken');
        if (savedToken) {
            authToken = savedToken;
            loadCurrentUser().then(() => {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showTab('dashboard');
            }).catch(() => {
                localStorage.removeItem('authToken');
            });
        }
    });
</script>
</body>
</html>
